import { useState, useEffect, useCallback, useRef, createContext, useContext } from "react";
import tenantConfig from "./config/tenant.json";
import { parseGondolaMaster, parseShelfPerformance, buildStoreData, exportShelfCSV, exportAllFixturesCSV, downloadCSV } from "./csv-parser.js";
import { evaluateAllProducts, parseCandidateCSV, matchCandidates } from "./dcs-engine.js";
import storeDataDefault from "./data/store-data.json";

// ============================================================
// TENANT CONFIG CONTEXT
// ============================================================
const TenantContext = createContext(tenantConfig);
const useTenant = () => useContext(TenantContext);

// ============================================================
// DATA - Will be loaded from API
// ============================================================
// These will be loaded from the API at app initialization
let FIXTURES = {};
let DEPARTMENTS = {};
let CATEGORIES = [];
let STORE_INFO = { company: '', storeName: '', periodFrom: '20260101', periodTo: '20260101', periodDays: 0 };

// Legacy compatibility
const AISLE_LAYOUT = null;
const SHELF_DATA_111 = null;
const SHELF_WIDTH_MM = 900;

// ============================================================
// DCS PROPOSALS - generated by DCS engine
// ============================================================
let DCS_PROPOSALS = [];
let DCS_RESULT = null;

function runDcsEngine(fixtures, periodDays) {
  DCS_RESULT = evaluateAllProducts(fixtures, periodDays);
  // Convert engine output to JAMES UI format
  DCS_PROPOSALS = Object.values(DCS_RESULT.proposals).map(p => {
    const actionMap = { cut: "ã‚«ãƒƒãƒˆ", faceReduce: "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›", faceIncrease: "ãƒ•ã‚§ãƒ¼ã‚¹å¢—" };
    const priorityMap = { rule1: "é«˜", rule2: "é«˜", rule3: "ä¸­", rule4: "ä½", faceUp: "ä½" };
    return {
      jan: p.jan,
      name: p.name,
      fixtureId: p.fixtureId,
      action: actionMap[p.action] || p.action,
      reason: p.reason,
      piValue: p.piValue?.toFixed(2) || "0",
      categoryAvgPi: DCS_RESULT.categoryStats[p.categoryName]?.median?.toFixed(2) || "-",
      lifecycle: p.rule === "rule1" ? "ã‚¼ãƒ­è²©" : p.rule === "rule3" ? "å»ƒæ£„ãƒªã‚¹ã‚¯" : "ä½PI",
      priority: priorityMap[p.rule] || "ä¸­",
      newFace: p.newFace,
      candidates: p.candidates || [],
      color: p.color,
      rule: p.rule,
      currentFace: p.currentFace,
    };
  });
  console.log(`[DCS] Engine evaluated: ${DCS_PROPOSALS.length} proposals (${DCS_RESULT.summary.cut} cut, ${DCS_RESULT.summary.faceReduce} reduce, ${DCS_RESULT.summary.faceIncrease} increase)`);
  return DCS_RESULT;
}

// ============================================================
// CANDIDATE PRODUCTS
// ============================================================
const CANDIDATE_PRODUCTS = [];

// Note: Real product data comes from FIXTURES

const DAYS = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

// æ®µã”ã¨ã®ä½¿ç”¨å¹…ã¨ç©ºãå¹…ã‚’è¨ˆç®—ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const calcRowWidth = (products, rowNum) => {
  const rowProds = products.filter(p => p.row === rowNum);
  return rowProds.reduce((s, p) => s + (p.width_mm || 90) * p.face, 0);
};
const calcRowFreeSpace = (products, rowNum, shelfWidthMm) => {
  return shelfWidthMm - calcRowWidth(products, rowNum);
};
// CAP = ãƒ•ã‚§ãƒ¼ã‚¹ Ã— å¥¥è¡Œ Ã— ç©æ®µæ•°  ï¼ˆç©æ®µæ•° = floor(æ£šé«˜ã• / å•†å“é«˜ã•)ï¼‰
const calcMaxStack = (heightMm, shelfRowHeightMm) => {
  if (!heightMm || !shelfRowHeightMm) return 1;
  return Math.max(1, Math.floor(shelfRowHeightMm / heightMm));
};
const calcCap = (face, depth, heightMm, shelfRowHeightMm) => {
  return face * depth * calcMaxStack(heightMm, shelfRowHeightMm);
};

// ã‚´ãƒ³ãƒ‰ãƒ©å…¨ä½“ã®åç›Šãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—
const calcGondolaMetrics = (products, shelfWidthMm, rowCount) => {
  const totalShelfWidth = (shelfWidthMm || 900) * (rowCount || 4);
  let totalWeekRevenue = 0, totalWeekProfit = 0, totalUsedMm = 0, totalPi = 0;
  let outOfStock = 0;
  const skuMetrics = [];

  products.forEach(p => {
    const weekSales = (p.salesWeek || [0,0,0,0,0,0,0]).reduce((a, b) => a + b, 0);
    const dailyAvg = p.dailyAvgQty || (weekSales / 7);
    const costPrice = Math.round(p.price * (p.costRate || 70) / 100);
    const grossProfit = p.price - costPrice;
    const weekRevenue = p.totalSales ? Math.round(p.totalSales / 7) : weekSales * p.price;
    const weekGross = p.totalProfit ? Math.round(p.totalProfit / 7) : weekSales * grossProfit;
    const usedMm = (p.width_mm || 90) * p.face;
    const pi = dailyAvg > 0 ? (dailyAvg * 1000 / 500) : 0;

    totalWeekRevenue += weekRevenue;
    totalWeekProfit += weekGross;
    totalUsedMm += usedMm;
    totalPi += pi;
    if (p.currentStock !== undefined && p.currentStock <= 0) outOfStock++;

    skuMetrics.push({
      jan: p.jan, name: p.name, rank: p.rank, row: p.row,
      weekRevenue, weekGross, usedMm,
      revenuePerMm: usedMm > 0 ? weekRevenue / usedMm : 0,
      profitPerMm: usedMm > 0 ? weekGross / usedMm : 0,
      pi, grossMarginRate: 100 - (p.costRate || 70),
      isLow: p.currentStock !== undefined && p.currentStock <= (p.orderPoint || 0)
    });
  });

  return {
    totalWeekRevenue, totalWeekProfit,
    totalMonthRevenue: Math.round(totalWeekRevenue * 4.3),
    totalMonthProfit: Math.round(totalWeekProfit * 4.3),
    fillRate: totalShelfWidth > 0 ? Math.round((totalUsedMm / totalShelfWidth) * 100) : 0,
    avgPi: products.length > 0 ? (totalPi / products.length) : 0,
    skuCount: products.length,
    outOfStockCount: outOfStock,
    outOfStockRate: products.length > 0 ? (outOfStock / products.length * 100) : 0,
    revenuePerMm: totalUsedMm > 0 ? totalWeekRevenue / totalUsedMm : 0,
    profitPerMm: totalUsedMm > 0 ? totalWeekProfit / totalUsedMm : 0,
    skuMetrics: skuMetrics.sort((a, b) => b.weekGross - a.weekGross),
    priorWeek: { revenue: Math.round(totalWeekRevenue * 0.97), profit: Math.round(totalWeekProfit * 0.98) }
  };
};

// ============================================================
// COMPONENTS
// ============================================================

const TagBadge = ({ tag }) => {
  if (!tag) return null;
  const colors = {
    "ãƒãƒ©ã‚·": { bg: "#EF4444", text: "#FFF" },
    "è²©ä¿ƒ": { bg: "#F59E0B", text: "#FFF" },
    "æ–°å•†å“": { bg: "#8B5CF6", text: "#FFF" },
    "ã‚«ãƒƒãƒˆ": { bg: "#1B2A4A", text: "#FFF" },
  };
  const c = colors[tag] || { bg: "#6B7280", text: "#FFF" };
  return (
    <span style={{
      position: "absolute", top: 2, right: 2, fontSize: 9, fontWeight: 700,
      background: c.bg, color: c.text, padding: "1px 5px", borderRadius: 3,
      lineHeight: "14px", letterSpacing: 0.5
    }}>{tag}</span>
  );
};

const RankBadge = ({ rank }) => {
  const colors = { A: "#0891B2", B: "#F59E0B", C: "#94A3B8" };
  return (
    <span style={{
      position: "absolute", top: 2, left: 2, fontSize: 10, fontWeight: 800,
      background: colors[rank] || "#94A3B8", color: "#FFF",
      width: 18, height: 18, borderRadius: 9, display: "inline-flex",
      alignItems: "center", justifyContent: "center", lineHeight: 1
    }}>{rank}</span>
  );
};

const StockBar = ({ current, base, orderPoint }) => {
  const pct = Math.min(100, (current / base) * 100);
  const opPct = (orderPoint / base) * 100;
  const isLow = current <= orderPoint;
  return (
    <div style={{ position: "relative", height: 4, background: "#E2E8F0", borderRadius: 2, marginTop: 3 }}>
      <div style={{ height: 4, borderRadius: 2, width: `${pct}%`, background: isLow ? "#EF4444" : "#10B981", transition: "width 0.3s" }} />
      <div style={{ position: "absolute", top: -2, left: `${opPct}%`, width: 1, height: 8, background: "#F59E0B" }} />
    </div>
  );
};

const SalesChart = ({ data, labels }) => {
  if (!data) return null;
  const max = Math.max(...data) * 1.2;
  const barW = 28;
  const h = 120;
  return (
    <div style={{ display: "flex", alignItems: "flex-end", gap: 4, padding: "8px 0" }}>
      {data.map((v, i) => (
        <div key={i} style={{ textAlign: "center", width: barW }}>
          <div style={{ fontSize: 9, color: "#64748B", marginBottom: 2 }}>{v}</div>
          <div style={{ height: (v / max) * h, background: i === data.length - 1 ? "#0891B2" : "#BAE6FD", borderRadius: "3px 3px 0 0", transition: "height 0.3s" }} />
          <div style={{ fontSize: 9, color: "#94A3B8", marginTop: 2 }}>{labels?.[i] || ""}</div>
        </div>
      ))}
    </div>
  );
};

const EditableNum = ({ value, onChange, min = 0, max = 999, step = 1, width = 50, label, unit = "", highlight = false }) => (
  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
    {label && <span style={{ fontSize: 10, color: "#64748B", minWidth: 60 }}>{label}</span>}
    <input type="number" value={value} min={min} max={max} step={step}
      onChange={e => onChange(parseFloat(e.target.value) || 0)}
      style={{
        width, textAlign: "center", border: highlight ? "2px solid #F59E0B" : "1px solid #CBD5E1",
        borderRadius: 4, padding: "3px 2px", fontSize: 12, fontWeight: 600,
        background: highlight ? "#FFFBEB" : "#FFF", color: "#1B2A4A"
      }} />
    {unit && <span style={{ fontSize: 10, color: "#94A3B8" }}>{unit}</span>}
  </div>
);

// ============================================================
// DCS PROPOSAL PANELï¼ˆAIæ¨è–¦â†’ãƒã‚¤ãƒ¤ãƒ¼æ‰¿èªï¼‰
// ============================================================
const DcsProposalPanel = ({ proposals, products, onApprove, onReject }) => {
  const getProduct = (jan) => products.find(p => p.jan === jan);
  const actionColors = { "ã‚«ãƒƒãƒˆ": "#D63031", "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›": "#E17055", "ãƒ•ã‚§ãƒ¼ã‚¹å¢—": "#2563EB" };

  return (
    <div style={{ background: "#FFF", border: "1px solid #E2E8F0", borderRadius: 8, overflow: "hidden" }}>
      <div style={{ background: "#0B1D3A", padding: "10px 14px", display: "flex", alignItems: "center", gap: 8 }}>
        <span style={{ fontSize: 14, fontWeight: 700, color: "#FFF" }}>DCS ã‚«ãƒƒãƒˆ/å¤‰æ›´ææ¡ˆ</span>
        <span style={{ fontSize: 10, color: "#94A3B8" }}>AIæ¨è–¦ â†’ ãƒã‚¤ãƒ¤ãƒ¼æ‰¿èª</span>
      </div>
      {proposals.map((prop, i) => {
        const p = getProduct(prop.jan);
        if (!p) return null;
        return (
          <div key={i} style={{ padding: "10px 14px", borderBottom: "1px solid #F1F5F9", display: "flex", alignItems: "center", gap: 10 }}>
            <div style={{
              width: 6, height: 40, borderRadius: 3, flexShrink: 0,
              background: prop.priority === "é«˜" ? "#D63031" : prop.priority === "ä¸­" ? "#E17055" : "#94A3B8"
            }} />
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                <span style={{
                  fontSize: 10, fontWeight: 700, padding: "1px 8px", borderRadius: 4,
                  background: actionColors[prop.action] || "#94A3B8", color: "#FFF"
                }}>{prop.action}</span>
                <span style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{p.name}</span>
              </div>
              <div style={{ fontSize: 9, color: "#64748B" }}>{prop.reason}</div>
              <div style={{ fontSize: 9, color: "#94A3B8", marginTop: 1 }}>
                {prop.rule === 'rule1' ? 'Rule1:ã‚¼ãƒ­è²©å£²' : prop.rule === 'rule2' ? 'Rule2:ä½PI' : prop.rule === 'rule3' ? 'Rule3:å»ƒæ£„ãƒªã‚¹ã‚¯' : prop.rule === 'rule4' ? 'Rule4:çµ±åˆå€™è£œ' : 'é«˜PI'} | PI:{prop.piValue} (ä¸­å¤®å€¤:{prop.categoryAvgPi}) | {p.row}æ®µ F:{p.face}â†’{prop.action === 'ã‚«ãƒƒãƒˆ' ? 'æ’¤å»' : prop.action === 'ãƒ•ã‚§ãƒ¼ã‚¹æ¸›' ? Math.max(1, p.face - 1) : Math.min(6, p.face + 1)}
              </div>
            </div>
            <div style={{ display: "flex", gap: 4, flexShrink: 0 }}>
              <button onClick={() => onApprove(prop)} style={{
                padding: "5px 10px", fontSize: 10, fontWeight: 700, border: "none", borderRadius: 4,
                background: "#00B894", color: "#FFF", cursor: "pointer"
              }}>æ‰¿èª</button>
              <button onClick={() => onReject(prop)} style={{
                padding: "5px 10px", fontSize: 10, fontWeight: 700, border: "1px solid #CBD5E1", borderRadius: 4,
                background: "#FFF", color: "#64748B", cursor: "pointer"
              }}>å´ä¸‹</button>
            </div>
          </div>
        );
      })}
      {proposals.length === 0 && (
        <div style={{ padding: 20, textAlign: "center", color: "#94A3B8", fontSize: 12 }}>ä¿ç•™ä¸­ã®ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
      )}
    </div>
  );
};

// ============================================================
// PRODUCT SWAP DIALOG
// ============================================================
const ProductSwapDialog = ({ currentProduct, candidates, onSwap, onClose }) => {
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState(null);
  const filtered = candidates.filter(c =>
    c.name.includes(search) || c.jan.includes(search) || c.maker.includes(search)
  );
  return (
    <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000 }}>
      <div style={{ background: "#FFF", borderRadius: 12, width: 480, maxHeight: "80vh", display: "flex", flexDirection: "column", boxShadow: "0 20px 60px rgba(0,0,0,0.3)" }}>
        <div style={{ padding: "16px 20px", borderBottom: "1px solid #E2E8F0" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div style={{ fontSize: 15, fontWeight: 700, color: "#1B2A4A" }}>å•†å“å…¥æ›¿ï¼ˆæ£šæ›¿ãˆï¼‰</div>
            <button onClick={onClose} style={{ background: "none", border: "none", fontSize: 20, cursor: "pointer", color: "#94A3B8" }}>Ã—</button>
          </div>
          <div style={{ fontSize: 11, color: "#64748B", marginTop: 4 }}>
            ç¾åœ¨: <strong>{currentProduct.name}</strong>ï¼ˆ{currentProduct.row}æ®µ F:{currentProduct.face} {(currentProduct.width_mm||90)*currentProduct.face}mmï¼‰
          </div>
        </div>
        <div style={{ padding: "12px 20px", borderBottom: "1px solid #E2E8F0" }}>
          <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="å•†å“åãƒ»JANãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢..."
            style={{ width: "100%", padding: "8px 12px", border: "1px solid #CBD5E1", borderRadius: 8, fontSize: 13 }} />
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "8px 20px" }}>
          {filtered.map(c => (
            <button key={c.jan} onClick={() => setSelected(c)} style={{
              display: "flex", alignItems: "center", gap: 12, width: "100%", textAlign: "left",
              padding: "10px 12px", background: selected?.jan === c.jan ? "#DBEAFE" : "#FFF",
              border: selected?.jan === c.jan ? "2px solid #0891B2" : "1px solid #E2E8F0",
              borderRadius: 8, marginBottom: 6, cursor: "pointer"
            }}>
              <div style={{ width: 36, height: 36, borderRadius: 8, background: c.color || "#F1F5F9", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 10, fontWeight: 700, color: c.rank === "A" ? "#0891B2" : c.rank === "B" ? "#F59E0B" : "#94A3B8" }}>{c.rank}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A" }}>{c.name}</div>
                <div style={{ fontSize: 10, color: "#64748B" }}>{c.maker}ã€€Â¥{c.price}ã€€JAN: {c.jan}</div>
              </div>
            </button>
          ))}
        </div>
        <div style={{ padding: "12px 20px", borderTop: "1px solid #E2E8F0", display: "flex", gap: 8 }}>
          <button onClick={onClose} style={{ flex: 1, padding: "10px 0", border: "1px solid #E2E8F0", borderRadius: 8, background: "#FFF", fontSize: 13, cursor: "pointer", fontWeight: 600, color: "#64748B" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onClick={() => selected && onSwap(selected)} disabled={!selected} style={{ flex: 1, padding: "10px 0", border: "none", borderRadius: 8, background: selected ? "#0891B2" : "#CBD5E1", color: "#FFF", fontSize: 13, cursor: selected ? "pointer" : "default", fontWeight: 700 }}>å…¥æ›¿å®Ÿè¡Œ</button>
        </div>
      </div>
    </div>
  );
};

// å•†å“è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
const AddProductDialog = ({ row, candidates, existingJans, onAdd, onClose, shelfWidthMm, currentRowWidth }) => {
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState(null);
  const available = candidates.filter(c => !existingJans.includes(c.jan));
  const filtered = available.filter(c =>
    c.name.includes(search) || c.jan.includes(search) || c.maker.includes(search)
  );
  const freeMm = (shelfWidthMm || 900) - (currentRowWidth || 0);

  return (
    <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000 }}>
      <div style={{ background: "#FFF", borderRadius: 12, width: 480, maxHeight: "80vh", display: "flex", flexDirection: "column", boxShadow: "0 20px 60px rgba(0,0,0,0.3)" }}>
        <div style={{ padding: "16px 20px", borderBottom: "1px solid #E2E8F0" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div style={{ fontSize: 15, fontWeight: 700, color: "#1B2A4A" }}>å•†å“è¿½åŠ </div>
            <button onClick={onClose} style={{ background: "none", border: "none", fontSize: 20, cursor: "pointer", color: "#94A3B8" }}>Ã—</button>
          </div>
          <div style={{ fontSize: 11, color: "#64748B", marginTop: 4 }}>
            {row}æ®µã«è¿½åŠ ã€€|ã€€ç©ºãã‚¹ãƒšãƒ¼ã‚¹: <strong style={{ color: freeMm > 100 ? "#10B981" : "#F59E0B" }}>{freeMm}mm</strong>
          </div>
        </div>
        <div style={{ padding: "12px 20px", borderBottom: "1px solid #E2E8F0" }}>
          <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="å•†å“åãƒ»JANãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢..."
            style={{ width: "100%", padding: "8px 12px", border: "1px solid #CBD5E1", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "8px 20px" }}>
          {filtered.length === 0 && (
            <div style={{ padding: 20, textAlign: "center", color: "#94A3B8", fontSize: 12 }}>
              {available.length === 0 ? "è¿½åŠ å¯èƒ½ãªå•†å“ãŒã‚ã‚Šã¾ã›ã‚“" : "æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“"}
            </div>
          )}
          {filtered.map(c => (
            <button key={c.jan} onClick={() => setSelected(c)} style={{
              display: "flex", alignItems: "center", gap: 12, width: "100%", textAlign: "left",
              padding: "10px 12px", background: selected?.jan === c.jan ? "#DBEAFE" : "#FFF",
              border: selected?.jan === c.jan ? "2px solid #0891B2" : "1px solid #E2E8F0",
              borderRadius: 8, marginBottom: 6, cursor: "pointer"
            }}>
              <div style={{ width: 36, height: 36, borderRadius: 8, background: c.color || "#F1F5F9", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 10, fontWeight: 700, color: c.rank === "A" ? "#0891B2" : c.rank === "B" ? "#F59E0B" : "#94A3B8" }}>{c.rank}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A" }}>{c.name}</div>
                <div style={{ fontSize: 10, color: "#64748B" }}>{c.maker}ã€€Â¥{c.price}ã€€{c.width_mm}mmå¹…</div>
              </div>
              {c.width_mm > freeMm && (
                <span style={{ fontSize: 9, color: "#DC2626", fontWeight: 600 }}>å¹…è¶…é</span>
              )}
            </button>
          ))}
        </div>
        <div style={{ padding: "12px 20px", borderTop: "1px solid #E2E8F0", display: "flex", gap: 8 }}>
          <button onClick={onClose} style={{ flex: 1, padding: "10px 0", border: "1px solid #E2E8F0", borderRadius: 8, background: "#FFF", fontSize: 13, cursor: "pointer", fontWeight: 600, color: "#64748B" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onClick={() => selected && onAdd(selected, row)} disabled={!selected} style={{ flex: 1, padding: "10px 0", border: "none", borderRadius: 8, background: selected ? "#0891B2" : "#CBD5E1", color: "#FFF", fontSize: 13, cursor: selected ? "pointer" : "default", fontWeight: 700 }}>è¿½åŠ </button>
        </div>
      </div>
    </div>
  );
};

// ============================================================
// CSV IMPORT PANEL
// ============================================================
const CsvImportPanel = ({ onDataImport }) => {
  const [masterFile, setMasterFile] = useState(null);
  const [perfFile, setPerfFile] = useState(null);
  const [importing, setImporting] = useState(false);
  const [result, setResult] = useState(null);
  const masterRef = useRef(null);
  const perfRef = useRef(null);

  const handleImport = async () => {
    if (!masterFile && !perfFile) {
      alert("å°‘ãªãã¨ã‚‚1ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }
    setImporting(true);
    setResult(null);
    try {
      let masterRecords = [];
      let perfRecords = [];

      if (masterFile) {
        const buf = await masterFile.arrayBuffer();
        masterRecords = parseGondolaMaster(buf);
      }
      if (perfFile) {
        const buf = await perfFile.arrayBuffer();
        perfRecords = parseShelfPerformance(buf);
      }

      if (masterRecords.length === 0 && perfRecords.length === 0) {
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        setImporting(false);
        return;
      }

      const storeData = buildStoreData(masterRecords, perfRecords);
      const fixtureCount = Object.keys(storeData.fixtures).length;
      const productCount = Object.values(storeData.fixtures).reduce((s, f) => s + (f.products?.length || 0), 0);
      const deptCount = Object.keys(storeData.departments).length;

      onDataImport(storeData);

      setResult({
        success: true,
        message: `å–è¾¼å®Œäº†: ${deptCount}éƒ¨é–€ / ${fixtureCount}ã‚´ãƒ³ãƒ‰ãƒ© / ${productCount}å•†å“`,
        details: `æœŸé–“: ${storeData.periodFrom || 'ä¸æ˜'} - ${storeData.periodTo || 'ä¸æ˜'}`
      });
      setMasterFile(null);
      setPerfFile(null);
      if (masterRef.current) masterRef.current.value = '';
      if (perfRef.current) perfRef.current.value = '';
    } catch (err) {
      setResult({ success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + err.message });
    } finally {
      setImporting(false);
    }
  };

  return (
    <div>
      <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 12 }}>
        <div>
          <label style={{ fontSize: 11, fontWeight: 600, color: "#475569", display: "block", marginBottom: 4 }}>ã‚´ãƒ³ãƒ‰ãƒ©å•†å“ãƒã‚¹ã‚¿ãƒ¼ CSV</label>
          <input ref={masterRef} type="file" accept=".csv" onChange={e => setMasterFile(e.target.files?.[0] || null)}
            style={{ fontSize: 12, width: "100%", padding: "6px", border: "1px solid #E2E8F0", borderRadius: 6, background: "#F8FAFC" }} />
        </div>
        <div>
          <label style={{ fontSize: 11, fontWeight: 600, color: "#475569", display: "block", marginBottom: 4 }}>æ£šå‰²å®Ÿç¸¾è¡¨ CSV</label>
          <input ref={perfRef} type="file" accept=".csv" onChange={e => setPerfFile(e.target.files?.[0] || null)}
            style={{ fontSize: 12, width: "100%", padding: "6px", border: "1px solid #E2E8F0", borderRadius: 6, background: "#F8FAFC" }} />
        </div>
      </div>
      <button onClick={handleImport} disabled={importing || (!masterFile && !perfFile)} style={{
        width: "100%", padding: "10px", background: (masterFile || perfFile) ? "linear-gradient(135deg, #6366F1, #8B5CF6)" : "#E2E8F0",
        color: (masterFile || perfFile) ? "#FFF" : "#94A3B8", border: "none", borderRadius: 8,
        fontSize: 13, fontWeight: 700, cursor: (masterFile || perfFile) ? "pointer" : "default"
      }}>
        {importing ? "å–è¾¼ä¸­..." : "ãƒ‡ãƒ¼ã‚¿å–è¾¼"}
      </button>
      {result && (
        <div style={{
          marginTop: 8, padding: "8px 12px", borderRadius: 8, fontSize: 12,
          background: result.success ? "#F0FDF4" : "#FEF2F2",
          color: result.success ? "#065F46" : "#991B1B",
          border: `1px solid ${result.success ? "#BBF7D0" : "#FECACA"}`
        }}>
          <div style={{ fontWeight: 600 }}>{result.message}</div>
          {result.details && <div style={{ fontSize: 11, marginTop: 2, opacity: 0.8 }}>{result.details}</div>}
        </div>
      )}
    </div>
  );
};

// ============================================================
// SCREENS
// ============================================================

const PortalScreen = ({ onNavigate, userName, dcsProcessed, dcsTaskDone, onDataImport }) => {
  const tenant = useTenant();
  const { brand, features, terms, operationMode } = tenant;
  const c = brand.colors;

  const cutCount = DCS_PROPOSALS.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length;
  const faceChangeCount = DCS_PROPOSALS.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length;
  const totalDcs = DCS_PROPOSALS.length;
  const proc = dcsProcessed || { cut: 0, face: 0, total: 0 };
  const done = dcsTaskDone || {};
  const cutRemaining = cutCount - proc.cut;
  const faceRemaining = faceChangeCount - proc.face;
  const allProcessed = cutRemaining <= 0 && faceRemaining <= 0;
  const allDone = done["ã‚«ãƒƒãƒˆæŒ‡ç¤º"] && done["ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´"];

  // DCSãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  const dcsMenuItems = [
    { label: terms.portal.normalOrder, icon: "ğŸ“¦", desc: "æ£šå‰²ãƒ™ãƒ¼ã‚¹ã®é€šå¸¸ç™ºæ³¨", action: () => onNavigate("category-select"), color: c.primary },
    { label: "ç‰¹å£²ç™ºæ³¨", icon: "ğŸ·ï¸", desc: "ç‰¹å£²ãƒ»ãƒãƒ©ã‚·å•†å“ã®ç™ºæ³¨", action: null, color: "#7C3AED" },
    { label: terms.portal.shelfManagement, icon: "ğŸ“", desc: "æ£šå‰²ã®ç¢ºèªãƒ»ä¿®æ­£", action: () => onNavigate("category-select"), color: c.success },
    { label: terms.portal.dcsProposal, icon: "ğŸ¤–", desc: `AIææ¡ˆã®æ‰¿èª${allDone ? "ï¼ˆå®Œäº†ï¼‰" : proc.total > 0 ? ` (æ®‹${totalDcs - proc.total}ä»¶)` : ` (${totalDcs}ä»¶)`}`, action: () => onNavigate("category-select-dcs"), badge: allDone ? 0 : totalDcs - proc.total, color: c.danger },
    { label: "å•†å“å°å¸³", icon: "ğŸ“‹", desc: "å•†å“ãƒã‚¹ã‚¿å‚ç…§", action: null, color: "#64748B" },
    { label: "ä¼ç”»è²©ä¿ƒ", icon: "ğŸ“¢", desc: "è²©ä¿ƒä¼ç”»ã®ç¢ºèª", action: null, color: c.warning },
    { label: "è²©å£²æ”¯æ´", icon: "ğŸ’¬", desc: "æ¥å®¢ãƒ»è²©å£²ã‚µãƒãƒ¼ãƒˆ", action: null, color: "#64748B" },
    { label: "çµ‚äº†", icon: "ğŸšª", desc: "", action: null, color: "#64748B" },
  ];

  // éDCSï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«/ã‚¢ã‚·ã‚¹ãƒˆï¼‰ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  const manualMenuItems = [
    { label: terms.portal.shelfManagement, icon: "ğŸ“", desc: "æ£šå‰²ã®ç¢ºèªãƒ»ç·¨é›†ãƒ»ã‚«ãƒƒãƒˆãƒ»å°å…¥", action: () => onNavigate("category-select"), color: c.primary },
    { label: terms.portal.normalOrder, icon: "ğŸ“¦", desc: "æ£šå‰²ãƒ™ãƒ¼ã‚¹ã®è£œå……ç™ºæ³¨", action: () => onNavigate("category-select"), color: c.success },
    { label: terms.portal.changeHistory, icon: "ğŸ“", desc: "æ£šå‰²å¤‰æ›´ã®å±¥æ­´ç¢ºèª", action: null, color: "#6366F1" },
    { label: terms.portal.instruction, icon: "ğŸ“„", desc: "åº—èˆ—ã¸ã®æ£šå‰²æŒ‡ç¤ºæ›¸", action: null, color: c.warning },
    { label: terms.portal.categoryAnalysis, icon: "ğŸ“Š", desc: "ã‚«ãƒ†ã‚´ãƒªåˆ¥å£²ä¸Šãƒ»åŠ¹ç‡åˆ†æ", action: null, color: "#8B5CF6" },
    { label: terms.portal.paramSettings, icon: "âš™ï¸", desc: "ç™ºæ³¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š", action: null, color: "#64748B" },
    { label: terms.portal.masterMaintenance, icon: "ğŸ“‹", desc: "å•†å“ãƒã‚¹ã‚¿å‚ç…§ãƒ»ç®¡ç†", action: null, color: "#64748B" },
    { label: "çµ‚äº†", icon: "ğŸšª", desc: "", action: null, color: "#64748B" },
  ];

  const menuItems = features.dcs ? dcsMenuItems : manualMenuItems;

  return (
    <div style={{ padding: 24, maxWidth: 600, margin: "0 auto", minHeight: "100vh", background: c.background }}>
      {/* ãƒˆãƒƒãƒ—ãƒãƒ¼ - ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒ€ãƒ¼ã‚¯ç¶­æŒï¼‰ */}
      <div style={{ background: `linear-gradient(135deg, ${c.dark} 0%, ${c.darkGrad} 100%)`, borderRadius: 16, padding: "18px 22px", marginBottom: 20, boxShadow: "0 4px 16px rgba(0,0,0,0.12)" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <div style={{ display: "flex", gap: 3, marginBottom: 4 }}>
              {brand.nameLetterColors
                ? brand.name.split("").map((ch, i) => (
                    <span key={i} style={{ fontSize: 28, fontWeight: 900, lineHeight: 1, color: brand.nameLetterColors[i % brand.nameLetterColors.length] }}>{ch}</span>
                  ))
                : <span style={{ fontSize: 28, fontWeight: 900, lineHeight: 1, color: c.primary }}>{brand.name}</span>
              }
            </div>
            <div style={{ fontSize: 9, color: "#475569", letterSpacing: 1.5 }}>{brand.subtitle.toUpperCase()}</div>
          </div>
          <div style={{ textAlign: "right" }}>
            <div style={{ fontSize: 13, color: c.headerText, fontWeight: 600 }}>{userName}</div>
            <div style={{ fontSize: 11, color: "#64748B" }}>
              {new Date().toLocaleDateString("ja-JP")} {new Date().toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}
            </div>
          </div>
        </div>
      </div>

      {/* DCSæŒ‡ç¤ºã‚µãƒãƒªãƒ¼ãƒãƒ¼ï¼ˆDCSãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ */}
      {features.dcs && totalDcs > 0 && (
        <div style={{ background: allDone ? "#F0FDF4" : "#FFF", border: `1px solid ${allDone ? "#BBF7D0" : "#E2E8F0"}`, borderRadius: 14, padding: "14px 16px", marginBottom: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.05)" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 10 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: "#1E293B" }}>
              {allDone ? `${terms.dcsProposal}ï¼ˆå…¨ä½œæ¥­å®Œäº†ï¼‰` : allProcessed ? `${terms.dcsProposal}ï¼ˆå‡¦ç†æ¸ˆãƒ»ç¢ºèªå¾…ã¡ï¼‰` : `${terms.dcsProposal}ï¼ˆæœªå‡¦ç†ã‚ã‚Šï¼‰`}
            </div>
            <div style={{ fontSize: 11, color: "#64748B" }}>
              åˆè¨ˆ {totalDcs}ä»¶
              {proc.total > 0 && <span style={{ color: c.success, fontWeight: 600 }}> / å‡¦ç†æ¸ˆ{proc.total}ä»¶</span>}
            </div>
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            {cutCount > 0 && (
              <div onClick={() => onNavigate("category-select-dcs")} style={{ flex: 1, background: cutRemaining <= 0 ? "#F0FDF4" : "#FEF2F2", border: `1px solid ${cutRemaining <= 0 ? "#BBF7D0" : "#FECACA"}`, borderRadius: 10, padding: "10px 10px", cursor: "pointer", transition: "all 0.15s" }}>
                <div style={{ fontSize: 20, fontWeight: 800, color: cutRemaining <= 0 ? c.success : c.danger }}>{cutCount}</div>
                <div style={{ fontSize: 11, fontWeight: 600, color: cutRemaining <= 0 ? "#065F46" : "#991B1B" }}>{terms.cut}æŒ‡ç¤º</div>
                {cutRemaining > 0
                  ? <div style={{ fontSize: 9, color: c.danger, marginTop: 2 }}>æ®‹{cutRemaining}ä»¶ è¦å¯¾å¿œ</div>
                  : done["ã‚«ãƒƒãƒˆæŒ‡ç¤º"]
                    ? <div style={{ fontSize: 9, color: c.success, marginTop: 2, fontWeight: 700 }}>ä½œæ¥­å®Œäº†</div>
                    : <div style={{ fontSize: 9, color: c.success, marginTop: 2 }}>å‡¦ç†æ¸ˆ</div>
                }
              </div>
            )}
            {faceChangeCount > 0 && (
              <div onClick={() => onNavigate("category-select-dcs")} style={{ flex: 1, background: faceRemaining <= 0 ? "#EFF6FF" : "#FFFBEB", border: `1px solid ${faceRemaining <= 0 ? "#BFDBFE" : "#FDE68A"}`, borderRadius: 10, padding: "10px 10px", cursor: "pointer", transition: "all 0.15s" }}>
                <div style={{ fontSize: 20, fontWeight: 800, color: faceRemaining <= 0 ? c.primary : c.warning }}>{faceChangeCount}</div>
                <div style={{ fontSize: 11, fontWeight: 600, color: faceRemaining <= 0 ? "#1E40AF" : "#92400E" }}>{terms.faceChange}</div>
                {faceRemaining > 0
                  ? <div style={{ fontSize: 9, color: c.warning, marginTop: 2 }}>æ®‹{faceRemaining}ä»¶ è¦å¯¾å¿œ</div>
                  : done["ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´"]
                    ? <div style={{ fontSize: 9, color: c.primary, marginTop: 2, fontWeight: 700 }}>ä½œæ¥­å®Œäº†</div>
                    : <div style={{ fontSize: 9, color: c.primary, marginTop: 2 }}>å‡¦ç†æ¸ˆ</div>
                }
              </div>
            )}
            <div onClick={() => onNavigate("category-select-dcs")} style={{ flex: 1, background: "#EEF2FF", border: "1px solid #C7D2FE", borderRadius: 10, padding: "10px 10px", cursor: "pointer", transition: "all 0.15s" }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: "#6366F1" }}>0</div>
              <div style={{ fontSize: 11, fontWeight: 600, color: "#4338CA" }}>{terms.swapProduct}</div>
              <div style={{ fontSize: 9, color: "#64748B", marginTop: 2 }}>ãªã—</div>
            </div>
          </div>
          {allDone ? (
            <div style={{ marginTop: 10, background: "#D1FAE5", color: "#065F46", borderRadius: 10, padding: "8px 0", fontSize: 12, fontWeight: 700, textAlign: "center" }}>å…¨ä½œæ¥­å®Œäº†</div>
          ) : (
            <button onClick={() => onNavigate("category-select-dcs")} style={{ width: "100%", marginTop: 10, background: `linear-gradient(135deg, ${c.primary}, ${c.accent})`, color: "#FFF", border: "none", borderRadius: 10, padding: "10px 0", fontSize: 12, fontWeight: 700, cursor: "pointer", boxShadow: `0 2px 8px ${c.primary}40` }}>
              {allProcessed ? "ç¢ºèªæ¸ˆã«ã™ã‚‹ â†’" : `${terms.dcsProposal}ã‚’ç¢ºèªãƒ»å‡¦ç†ã™ã‚‹ â†’`}
            </button>
          )}
        </div>
      )}

      {/* éDCSãƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ†ã‚´ãƒªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼ */}
      {!features.dcs && features.categoryReview && (
        <div style={{ background: "#FFF", border: "1px solid #E2E8F0", borderRadius: 14, padding: "14px 16px", marginBottom: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.05)" }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: "#1E293B", marginBottom: 8 }}>ã‚«ãƒ†ã‚´ãƒªãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ³</div>
          <div style={{ display: "flex", gap: 8 }}>
            <div style={{ flex: 1, background: "#FEF2F2", border: "1px solid #FECACA", borderRadius: 10, padding: "10px", textAlign: "center" }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: c.danger }}>3</div>
              <div style={{ fontSize: 10, color: "#991B1B", fontWeight: 600 }}>ãƒ¬ãƒ“ãƒ¥ãƒ¼æœŸé™è¶…é</div>
            </div>
            <div style={{ flex: 1, background: "#FFFBEB", border: "1px solid #FDE68A", borderRadius: 10, padding: "10px", textAlign: "center" }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: c.warning }}>5</div>
              <div style={{ fontSize: 10, color: "#92400E", fontWeight: 600 }}>ä»Šæœˆãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š</div>
            </div>
            <div style={{ flex: 1, background: "#F0FDF4", border: "1px solid #BBF7D0", borderRadius: 10, padding: "10px", textAlign: "center" }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: c.success }}>8</div>
              <div style={{ fontSize: 10, color: "#065F46", fontWeight: 600 }}>ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ</div>
            </div>
          </div>
        </div>
      )}

      {/* ã‚«ãƒƒãƒˆå€™è£œã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆéDCS + cutSuggestionæœ‰åŠ¹æ™‚ï¼‰ */}
      {!features.dcs && features.cutSuggestion && (
        <div style={{ background: "#FFF", border: "1px solid #FECACA", borderRadius: 14, padding: "14px 16px", marginBottom: 16, boxShadow: "0 1px 4px rgba(0,0,0,0.05)" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: "#991B1B" }}>{terms.cut}å€™è£œã‚¢ãƒ©ãƒ¼ãƒˆ</div>
            <span style={{ fontSize: 10, color: "#64748B" }}>ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è‡ªå‹•æ¤œå‡º</span>
          </div>
          <div style={{ fontSize: 11, color: "#64748B", lineHeight: "18px" }}>
            PIå€¤ãŒã‚«ãƒ†ã‚´ãƒªå¹³å‡ã®30%ä»¥ä¸‹ã€ã¾ãŸã¯4é€±é€£ç¶šå£²ä¸Šæ¸›å°‘ã®å•†å“ãŒ <strong style={{ color: c.danger }}>5å“</strong> æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚
          </div>
          <button onClick={() => onNavigate("category-select")} style={{ width: "100%", marginTop: 8, background: `linear-gradient(135deg, ${c.primary}, ${c.accent || c.primary})`, color: "#FFF", border: "none", borderRadius: 8, padding: "8px 0", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
            æ£šå‰²ç·¨é›†ã§ç¢ºèªã™ã‚‹ â†’
          </button>
        </div>
      )}

      <div style={{ fontSize: 14, fontWeight: 700, color: "#1E293B", marginBottom: 12, paddingLeft: 4, display: "flex", alignItems: "center", gap: 8 }}>
        <div style={{ width: 3, height: 18, background: c.primary, borderRadius: 2 }} />
        {features.dcs ? "MDãƒ¡ãƒ‹ãƒ¥ãƒ¼" : "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼"}
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
        {menuItems.map((item, i) => (
          <button key={i} onClick={item.action} disabled={!item.action} style={{
            background: item.action ? "#FFF" : c.background,
            border: item.action ? "1px solid #E2E8F0" : "1px solid #F1F5F9",
            borderRadius: 14, padding: "16px 14px", cursor: item.action ? "pointer" : "default",
            textAlign: "left", opacity: item.action ? 1 : 0.4, position: "relative",
            boxShadow: item.action ? "0 2px 8px rgba(0,0,0,0.05)" : "none",
            transition: "all 0.2s", borderLeft: item.action ? `4px solid ${item.color}` : "4px solid transparent"
          }}>
            {item.badge > 0 && (
              <div style={{ position: "absolute", top: 8, right: 8, background: c.danger, color: "#FFF", borderRadius: 10, padding: "2px 8px", fontSize: 11, fontWeight: 800, minWidth: 20, textAlign: "center", boxShadow: `0 2px 4px ${c.danger}4D` }}>{item.badge}</div>
            )}
            <div style={{ fontSize: 26, marginBottom: 4 }}>{item.icon}</div>
            <div style={{ fontSize: 14, fontWeight: 700, color: "#1E293B" }}>{item.label}</div>
            <div style={{ fontSize: 10, color: "#94A3B8", marginTop: 2, lineHeight: "14px" }}>{item.desc}</div>
          </button>
        ))}
      </div>

      {/* CSV ãƒ‡ãƒ¼ã‚¿å–è¾¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
      <div style={{ marginTop: 20 }}>
        <div style={{ fontSize: 14, fontWeight: 700, color: "#1E293B", marginBottom: 12, paddingLeft: 4, display: "flex", alignItems: "center", gap: 8 }}>
          <div style={{ width: 3, height: 18, background: "#6366F1", borderRadius: 2 }} />
          ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        </div>
        <div style={{ background: "#FFF", border: "1px solid #E2E8F0", borderRadius: 14, padding: "16px", boxShadow: "0 2px 8px rgba(0,0,0,0.05)" }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: "#1E293B", marginBottom: 8 }}>åŸºå¹¹ãƒ‡ãƒ¼ã‚¿å–è¾¼ï¼ˆCSVï¼‰</div>
          <div style={{ fontSize: 11, color: "#64748B", marginBottom: 12, lineHeight: "16px" }}>
            åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã€Œã‚´ãƒ³ãƒ‰ãƒ©å•†å“ãƒã‚¹ã‚¿ãƒ¼ã€ã¨ã€Œæ£šå‰²å®Ÿç¸¾è¡¨ã€ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚
          </div>
          <CsvImportPanel onDataImport={onDataImport} />
        </div>
      </div>
    </div>
  );
};

// DCSææ¡ˆã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é›†è¨ˆã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const getDcsSummaryByCategory = () => {
  const summary = {};
  // DCS_PROPOSALSã®å„ææ¡ˆã®JANã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’ç‰¹å®š
  DCS_PROPOSALS.forEach(prop => {
    // Find product in fixtures
    let product = null;
    let departmentKey = null;

    for (const [key, fixture] of Object.entries(FIXTURES)) {
      const found = fixture.products?.find(p => p.jan === prop.jan);
      if (found) {
        product = found;
        departmentKey = fixture.department;
        break;
      }
    }

    if (product && departmentKey) {
      if (!summary[departmentKey]) summary[departmentKey] = { cut: 0, faceChange: 0, swap: 0, total: 0, items: [] };
      if (prop.action === "ã‚«ãƒƒãƒˆ") summary[departmentKey].cut++;
      else if (prop.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || prop.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—") summary[departmentKey].faceChange++;
      summary[departmentKey].total++;
      summary[departmentKey].items.push({ ...prop, productName: product.name });
    }
  });
  return summary;
};

const CategorySelectScreen = ({ onSelect, onBack, showDcs }) => {
  // Show main departments
  const mainDepartments = CATEGORIES;
  const dcsSummary = showDcs ? getDcsSummaryByCategory() : {};

  return (
    <div style={{ padding: 16, maxWidth: 600, margin: "0 auto" }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16 }}>
        <button onClick={onBack} style={backBtnStyle}>â† TOP</button>
        <div style={{ fontSize: 16, fontWeight: 700, color: "#1B2A4A" }}>
          {showDcs ? "DCSæŒ‡ç¤º â€” å£²å ´ã‚’é¸æŠ" : "å£²å ´ã‚’é¸æŠ"}
        </div>
        <span style={{ fontSize: 10, fontWeight: 800, color: "#0891B2", letterSpacing: 1, marginLeft: "auto" }}>JAMES</span>
      </div>

      {/* DCS ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼šæŒ‡ç¤ºã‚µãƒãƒªãƒ¼ */}
      {showDcs && Object.keys(dcsSummary).length > 0 && (
        <div style={{ background: "#FFFBEB", border: "1px solid #FDE68A", borderRadius: 10, padding: "12px 14px", marginBottom: 16 }}>
          <div style={{ fontSize: 12, fontWeight: 700, color: "#92400E", marginBottom: 4 }}>æœªå‡¦ç†ã®DCSæŒ‡ç¤ºãŒã‚ã‚‹ã‚«ãƒ†ã‚´ãƒª</div>
          <div style={{ fontSize: 11, color: "#B45309" }}>
            å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªã«ãƒãƒƒã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã—ã¦ç¢ºèªãƒ»å‡¦ç†ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      )}

      <div style={{ fontSize: 13, fontWeight: 700, color: "#0891B2", marginBottom: 6, paddingLeft: 4 }}>éƒ¨é–€ä¸€è¦§</div>
      {mainDepartments.map(c => {
        const gondolaCodes = c.gondolaCodes || [];
        const dcs = dcsSummary[c.id];
        const hasDcs = showDcs && dcs && dcs.total > 0;

        // Calculate aggregated sales/profit for department
        let totalSales = 0, totalProfit = 0;
        gondolaCodes.forEach(gCode => {
          const fixture = FIXTURES[gCode];
          if (fixture) {
            totalSales += fixture.totalSales || 0;
            totalProfit += fixture.totalProfit || 0;
          }
        });

        return (
          <button key={c.id} onClick={() => onSelect(c.id)} style={{
            display: "block", width: "100%", textAlign: "left", padding: "14px 16px",
            background: hasDcs ? "#FFF7ED" : "#FFF",
            border: hasDcs ? "2px solid #FB923C" : "1px solid #E2E8F0",
            borderRadius: 10, marginBottom: 8, cursor: "pointer", fontSize: 14, color: "#1B2A4A",
            boxShadow: hasDcs ? "0 2px 8px rgba(251,146,60,0.15)" : "0 1px 2px rgba(0,0,0,0.04)",
            transition: "all 0.15s"
          }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
              <div style={{ fontWeight: 700, fontSize: 15 }}>{c.name}</div>
              {hasDcs && (
                <div style={{ display: "flex", gap: 6, flexShrink: 0, marginLeft: 8 }}>
                  {dcs.cut > 0 && (
                    <span style={{ background: "#DC2626", color: "#FFF", fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, whiteSpace: "nowrap" }}>
                      ã‚«ãƒƒãƒˆ {dcs.cut}ä»¶
                    </span>
                  )}
                  {dcs.faceChange > 0 && (
                    <span style={{ background: "#D97706", color: "#FFF", fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, whiteSpace: "nowrap" }}>
                      Få¤‰æ›´ {dcs.faceChange}ä»¶
                    </span>
                  )}
                </div>
              )}
            </div>
            <div style={{ fontSize: 12, color: "#64748B" }}>
              ã‚´ãƒ³ãƒ‰ãƒ©: {gondolaCodes.length}æœ¬ | å£²ä¸Š: Â¥{totalSales.toLocaleString()} | åˆ©ç›Š: Â¥{totalProfit.toLocaleString()}
            </div>
            {hasDcs && (
              <div style={{ marginTop: 8, display: "flex", flexWrap: "wrap", gap: 4 }}>
                {dcs.items.slice(0, 3).map((item, i) => (
                  <span key={i} style={{
                    fontSize: 9, padding: "2px 6px", borderRadius: 4,
                    background: item.action === "ã‚«ãƒƒãƒˆ" ? "#FEE2E2" : item.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—" ? "#DBEAFE" : "#FEF3C7",
                    color: item.action === "ã‚«ãƒƒãƒˆ" ? "#991B1B" : item.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—" ? "#1E40AF" : "#92400E"
                  }}>
                    {item.action}: {item.productName.length > 10 ? item.productName.slice(0, 10) + "â€¦" : item.productName}
                  </span>
                ))}
                {dcs.items.length > 3 && (
                  <span style={{ fontSize: 9, color: "#94A3B8", padding: "2px 4px" }}>ä»–{dcs.items.length - 3}ä»¶</span>
                )}
              </div>
            )}
          </button>
        );
      })}
    </div>
  );
};

// ============================================================
// SHELF VIEW SCREEN (main)
// ============================================================
const ShelfViewScreen = ({ data, onBack, onHome, showDcs, onDcsProcessedChange, onDcsTaskDoneChange, dcsTaskDone: parentDcsTaskDone }) => {
  const tenant = useTenant();
  const { brand, features, terms } = tenant;
  const tc = brand.colors;

  // Get the department and initial fixture from route data
  const departmentKey = data?.departmentKey || Object.keys(DEPARTMENTS)[0];
  const gondolaCodes = DEPARTMENTS[departmentKey] || [];
  const initialFixtureId = gondolaCodes[0] || null;

  const [currentFixtureId, setCurrentFixtureId] = useState(initialFixtureId);
  const [currentFixture, setCurrentFixture] = useState(null);
  const [fixtureLoading, setFixtureLoading] = useState(false);

  const [viewMode, setViewMode] = useState("shelf");
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [products, setProducts] = useState([]);
  const [deletedProducts, setDeletedProducts] = useState([]); // ã‚«ãƒƒãƒˆæ¸ˆã¿å•†å“
  const [detailTab, setDetailTab] = useState("order");
  const [orderMemo, setOrderMemo] = useState("");
  const [editMode, setEditMode] = useState(false);
  const [showSwapDialog, setShowSwapDialog] = useState(false);
  const [showDcsPanel, setShowDcsPanel] = useState(showDcs || false);
  const [addProductRow, setAddProductRow] = useState(null); // å•†å“è¿½åŠ å…ˆã®æ®µç•ªå·
  const [showSaveMenu, setShowSaveMenu] = useState(false);
  const fileInputRef = useRef(null);
  const [dcsProposals, setDcsProposals] = useState(DCS_PROPOSALS);
  const [dragItem, setDragItem] = useState(null);
  const [changeLog, setChangeLog] = useState([]);
  const [taskCompleted, setTaskCompleted] = useState(parentDcsTaskDone || {});

  // Load fixture data from bundled data when currentFixtureId changes
  useEffect(() => {
    if (!currentFixtureId) return;
    const fixture = FIXTURES[currentFixtureId];
    if (fixture) {
      setCurrentFixture(fixture);
      setProducts(fixture.products || []);
      setSelectedProduct(null);
      setDeletedProducts([]);
      setViewMode("shelf");
    } else {
      console.error('Fixture not found:', currentFixtureId);
      setCurrentFixture(null);
      setProducts([]);
    }
  }, [currentFixtureId]);

  // --- Undo/Redo ---
  const [history, setHistory] = useState([]);
  const [historyIdx, setHistoryIdx] = useState(-1);
  const isUndoRedo = useRef(false);

  // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ï¼ˆproductså¤‰æ›´æ™‚ï¼‰
  useEffect(() => {
    if (isUndoRedo.current) { isUndoRedo.current = false; return; }
    setHistory(prev => {
      const newHist = prev.slice(0, historyIdx + 1);
      newHist.push(JSON.parse(JSON.stringify(products)));
      if (newHist.length > 20) newHist.shift();
      return newHist;
    });
    setHistoryIdx(prev => Math.min(prev + 1, 19));
  }, [products]);

  const canUndo = historyIdx > 0;
  const canRedo = historyIdx < history.length - 1;

  const handleUndo = () => {
    if (!canUndo) return;
    isUndoRedo.current = true;
    const newIdx = historyIdx - 1;
    setHistoryIdx(newIdx);
    const snapshot = JSON.parse(JSON.stringify(history[newIdx]));
    setProducts(snapshot);
    setSelectedProduct(null);
    addLog("å…ƒã«æˆ»ã™ (Undo)");
  };
  const handleRedo = () => {
    if (!canRedo) return;
    isUndoRedo.current = true;
    const newIdx = historyIdx + 1;
    setHistoryIdx(newIdx);
    const snapshot = JSON.parse(JSON.stringify(history[newIdx]));
    setProducts(snapshot);
    setSelectedProduct(null);
    addLog("ã‚„ã‚Šç›´ã— (Redo)");
  };

  const addLog = (msg) => setChangeLog(prev => [{ time: new Date().toLocaleTimeString("ja-JP"), msg }, ...prev].slice(0, 50));

  // DCSæŒ‡ç¤ºã‚µãƒãƒªãƒ¼é›†è¨ˆ
  const dcsCutCount = DCS_PROPOSALS.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length;
  const dcsFaceChangeCount = DCS_PROPOSALS.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length;
  const dcsSwapCount = 0; // å•†å“å…¥æ›¿ã¯å°†æ¥ã®æ‹¡å¼µç”¨
  const dcsCutRemaining = dcsProposals.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length;
  const dcsFaceRemaining = dcsProposals.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length;

  const markTaskDone = (key) => {
    setTaskCompleted(prev => {
      const next = { ...prev, [key]: true };
      if (onDcsTaskDoneChange) onDcsTaskDoneChange(next);
      return next;
    });
  };

  // --- Order & param handlers ---
  const handleOrderChange = (jan, qty) => {
    setProducts(prev => prev.map(p => p.jan === jan ? { ...p, orderQty: Math.max(0, qty) } : p));
    if (selectedProduct?.jan === jan) setSelectedProduct(prev => ({ ...prev, orderQty: Math.max(0, qty) }));
  };

  // è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆé€£ç¶šå‘¼ã³å‡ºã—ã§ã®ä¸Šæ›¸ãé˜²æ­¢ï¼‰
  const handleParamChange = (jan, field, value) => {
    setProducts(prev => {
      const updated = prev.map(p => p.jan === jan ? { ...p, [field]: value } : p);
      const prod = updated.find(p => p.jan === jan);
      if (selectedProduct?.jan === jan) setSelectedProduct({ ...prod });
      return updated;
    });
    addLog(`${field}=${value}`);
  };

  const handleParamChangeBatch = (jan, changes) => {
    setProducts(prev => {
      const updated = prev.map(p => p.jan === jan ? { ...p, ...changes } : p);
      const prod = updated.find(p => p.jan === jan);
      if (selectedProduct?.jan === jan) setSelectedProduct({ ...prod });
      return updated;
    });
    addLog(Object.entries(changes).map(([k,v]) => `${k}=${v}`).join(", "));
  };

  // --- Facing change with shelf width constraint ---
  const handleFaceChange = (jan, newFace) => {
    if (newFace <= 0) {
      handleDeleteProduct(jan);
      return;
    }
    const val = Math.min(6, newFace);
    const prod = products.find(p => p.jan === jan);
    if (!prod) return;
    // æ£šå¹…ã‚ªãƒ¼ãƒãƒ¼ãƒã‚§ãƒƒã‚¯
    const widthMm = prod.width_mm || 90;
    const currentRowWidth = calcRowWidth(products, prod.row);
    const delta = (val - prod.face) * widthMm;
    const newRowWidth = currentRowWidth + delta;
    const shelfMm = data.shelfWidthMm || 900;
    if (newRowWidth > shelfMm) {
      const overMm = newRowWidth - shelfMm;
      if (!window.confirm(`æ£šå¹…ã‚’${overMm}mmè¶…éã—ã¾ã™ï¼ˆ${newRowWidth}mm / ${shelfMm}mmï¼‰ã€‚\nã“ã®ã¾ã¾å¢—ã‚„ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    }
    const rowH = (data.rowHeights || {})[prod.row] || 300;
    const newCap = calcCap(val, prod.depth || 3, prod.height_mm || 200, rowH);
    handleParamChangeBatch(jan, { face: val, cap: newCap });
  };

  // --- Delete product (ã‚«ãƒƒãƒˆ) ---
  const handleDeleteProduct = (jan) => {
    const prod = products.find(p => p.jan === jan);
    if (!prod) return;
    if (!window.confirm(`ã€Œ${prod.name}ã€ã‚’æ£šã‹ã‚‰å‰Šé™¤ï¼ˆã‚«ãƒƒãƒˆï¼‰ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    setProducts(prev => prev.filter(p => p.jan !== jan));
    setDeletedProducts(prev => [...prev, { ...prod, deletedAt: new Date().toLocaleString("ja-JP") }]);
    if (selectedProduct?.jan === jan) setSelectedProduct(null);
    addLog(`${prod.name} ã‚’æ£šã‹ã‚‰ã‚«ãƒƒãƒˆ`);
  };

  // --- Restore deleted product ---
  const handleRestoreProduct = (jan) => {
    const prod = deletedProducts.find(p => p.jan === jan);
    if (!prod) return;
    const { deletedAt, ...restored } = prod;
    setProducts(prev => [...prev, restored]);
    setDeletedProducts(prev => prev.filter(p => p.jan !== jan));
    addLog(`${prod.name} ã‚’æ£šã«å¾©å…ƒ`);
  };

  // --- DCS proposal approve/reject ---
  const handleDcsApprove = (proposal) => {
    if (proposal.action === "ã‚«ãƒƒãƒˆ") {
      handleDeleteProduct(proposal.jan);
    } else if (proposal.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›") {
      const prod = products.find(p => p.jan === proposal.jan);
      if (prod) { const nf = Math.max(1, prod.face + (proposal.newFace || -1)); const rowH = (currentFixture?.rowHeights || {})[prod.row] || 300; handleParamChangeBatch(proposal.jan, { face: nf, cap: calcCap(nf, prod.depth || 3, prod.height_mm || 200, rowH) }); }
    } else if (proposal.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—") {
      const prod = products.find(p => p.jan === proposal.jan);
      if (prod) { const nf = Math.min(6, prod.face + (proposal.newFace || 1)); const rowH = (currentFixture?.rowHeights || {})[prod.row] || 300; handleParamChangeBatch(proposal.jan, { face: nf, cap: calcCap(nf, prod.depth || 3, prod.height_mm || 200, rowH) }); }
    }
    setDcsProposals(prev => {
      const next = prev.filter(p => p.jan !== proposal.jan);
      if (onDcsProcessedChange) {
        const cutDone = DCS_PROPOSALS.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length - next.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length;
        const faceDone = DCS_PROPOSALS.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length - next.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length;
        onDcsProcessedChange({ cut: cutDone, face: faceDone, total: cutDone + faceDone });
      }
      return next;
    });
    addLog(`DCSææ¡ˆæ‰¿èª: ${proposal.action} ${proposal.jan}`);
    // APIé€šçŸ¥ï¼ˆéåŒæœŸã€å¤±æ•—ã—ã¦ã‚‚ç”»é¢ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰
    fetch(`${API_BASE}/api/dcs/proposals/approve`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jan: proposal.jan, userName: 'buyer' })
    }).catch(e => console.warn('[DCS] approve API error:', e.message));
  };

  const handleDcsReject = (proposal) => {
    setDcsProposals(prev => {
      const next = prev.filter(p => p.jan !== proposal.jan);
      if (onDcsProcessedChange) {
        const cutDone = DCS_PROPOSALS.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length - next.filter(d => d.action === "ã‚«ãƒƒãƒˆ").length;
        const faceDone = DCS_PROPOSALS.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length - next.filter(d => d.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›" || d.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—").length;
        onDcsProcessedChange({ cut: cutDone, face: faceDone, total: cutDone + faceDone });
      }
      return next;
    });
    addLog(`DCSææ¡ˆå´ä¸‹: ${proposal.action} ${proposal.jan}`);
    // APIé€šçŸ¥
    fetch(`${API_BASE}/api/dcs/proposals/reject`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jan: proposal.jan, userName: 'buyer', reason: '' })
    }).catch(e => console.warn('[DCS] reject API error:', e.message));
  };

  // --- Drag & Drop (é…åˆ—é †åºã‚’å®Ÿéš›ã«ä¸¦ã³æ›¿ãˆ) ---
  const handleDragStart = (product) => { if (editMode) setDragItem(product); };
  const handleDrop = (targetRow, targetIdx) => {
    if (!dragItem || !editMode) return;
    setProducts(prev => {
      const arr = [...prev];
      const dragIdx = arr.findIndex(p => p.jan === dragItem.jan);
      if (dragIdx < 0) return prev;
      const [moved] = arr.splice(dragIdx, 1);
      moved.row = targetRow;
      const rowItems = arr.filter(p => p.row === targetRow);
      if (targetIdx >= rowItems.length) {
        const lastInRow = rowItems[rowItems.length - 1];
        const insertAt = lastInRow ? arr.indexOf(lastInRow) + 1 : arr.length;
        arr.splice(insertAt, 0, moved);
      } else {
        const targetProduct = rowItems[targetIdx];
        const insertAt = arr.indexOf(targetProduct);
        arr.splice(insertAt, 0, moved);
      }
      return arr;
    });
    addLog(`${dragItem.name} â†’ ${targetRow}æ®µã«ç§»å‹•`);
    setDragItem(null);
  };

  // --- Touch Drag & Drop (iPadå¯¾å¿œ) ---
  const touchRef = useRef({ startX: 0, startY: 0, product: null, ghost: null, moved: false });
  const shelfGridRef = useRef(null);

  const handleTouchStart = (product, e) => {
    if (!editMode) return;
    const touch = e.touches[0];
    touchRef.current = { startX: touch.clientX, startY: touch.clientY, product, ghost: null, moved: false };
    // é•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆ300msï¼‰
    touchRef.current.timer = setTimeout(() => {
      setDragItem(product);
      touchRef.current.moved = true;
      // ã‚´ãƒ¼ã‚¹ãƒˆè¦ç´ ä½œæˆ
      const ghost = document.createElement("div");
      ghost.textContent = product.name.slice(0, 8);
      ghost.style.cssText = "position:fixed;padding:8px 12px;background:#0284C7;color:#FFF;border-radius:8px;font-size:12px;font-weight:700;pointer-events:none;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.3);transform:translate(-50%,-50%);white-space:nowrap;";
      ghost.style.left = touch.clientX + "px";
      ghost.style.top = touch.clientY + "px";
      document.body.appendChild(ghost);
      touchRef.current.ghost = ghost;
    }, 300);
  };

  const handleTouchMove = useCallback((e) => {
    if (!touchRef.current.moved && !touchRef.current.timer) return;
    const touch = e.touches[0];
    const dx = Math.abs(touch.clientX - touchRef.current.startX);
    const dy = Math.abs(touch.clientY - touchRef.current.startY);
    // å°‘ã—ã§ã‚‚å‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ„å›³ï¼‰
    if (!touchRef.current.moved && (dx > 10 || dy > 10)) {
      clearTimeout(touchRef.current.timer);
      touchRef.current.timer = null;
      return;
    }
    if (!touchRef.current.moved) return;
    e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
    // ã‚´ãƒ¼ã‚¹ãƒˆç§»å‹•
    if (touchRef.current.ghost) {
      touchRef.current.ghost.style.left = touch.clientX + "px";
      touchRef.current.ghost.style.top = touch.clientY + "px";
    }
  }, []);

  const handleTouchEnd = useCallback((e) => {
    clearTimeout(touchRef.current.timer);
    touchRef.current.timer = null;
    if (touchRef.current.ghost) {
      document.body.removeChild(touchRef.current.ghost);
      touchRef.current.ghost = null;
    }
    if (!touchRef.current.moved || !dragItem) { touchRef.current.moved = false; return; }

    // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã‚’åˆ¤å®š: ã‚¿ãƒƒãƒä½ç½®ã®è¦ç´ ã‹ã‚‰ data-row, data-idx ã‚’å–å¾—
    const touch = e.changedTouches[0];
    const dropEl = document.elementFromPoint(touch.clientX, touch.clientY);
    if (dropEl) {
      const rowEl = dropEl.closest("[data-drop-row]");
      if (rowEl) {
        const targetRow = parseInt(rowEl.dataset.dropRow);
        const targetIdx = parseInt(rowEl.dataset.dropIdx || "999");
        handleDrop(targetRow, targetIdx);
      }
    }
    touchRef.current.moved = false;
    setDragItem(null);
  }, [dragItem]);

  // --- Product swap ---
  const handleProductSwap = (newProduct) => {
    if (!selectedProduct) return;
    const oldName = selectedProduct.name;
    setProducts(prev => prev.map(p => {
      if (p.jan === selectedProduct.jan) {
        return { ...p, jan: newProduct.jan, name: newProduct.name, maker: newProduct.maker, price: newProduct.price, rank: newProduct.rank, color: newProduct.color || "#F1F5F9", currentStock: 0, orderQty: 0, salesWeek: [0,0,0,0,0,0,0], stockCorrection: 0 };
      }
      return p;
    }));
    addLog(`${oldName} â†’ ${newProduct.name} ã«å…¥æ›¿ãˆ`);
    setSelectedProduct(null);
    setShowSwapDialog(false);
  };

  // --- Add new product to shelf ---
  const handleAddProduct = (candidate, row) => {
    const rowH = (data.rowHeights || {})[row] || 300;
    const newProduct = {
      row,
      jan: candidate.jan,
      name: candidate.name,
      maker: candidate.maker,
      price: candidate.price,
      costRate: candidate.costRate || 65,
      rank: candidate.rank || "B",
      face: 1,
      width_mm: candidate.width_mm || 75,
      height_mm: candidate.height_mm || 200,
      depth: candidate.depth || 3,
      cap: calcCap(1, candidate.depth || 3, candidate.height_mm || 200, rowH),
      baseStock: 10,
      currentStock: 0,
      orderPoint: 4,
      orderQty: 0,
      inventoryDays: 2.0,
      leadTime: 1,
      minOrderUnit: 1,
      stockCorrection: 0,
      tag: "æ–°å•†å“",
      salesWeek: [0,0,0,0,0,0,0],
      color: candidate.color || "#F1F5F9"
    };
    // æ£šå¹…ãƒã‚§ãƒƒã‚¯
    const currentWidth = calcRowWidth(products, row);
    const addWidth = (newProduct.width_mm) * newProduct.face;
    const shelfMm = data.shelfWidthMm || 900;
    if (currentWidth + addWidth > shelfMm) {
      if (!window.confirm(`æ£šå¹…ã‚’è¶…éã—ã¾ã™ï¼ˆ${currentWidth + addWidth}mm / ${shelfMm}mmï¼‰ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    }
    setProducts(prev => [...prev, newProduct]);
    addLog(`${candidate.name} ã‚’ ${row}æ®µã«è¿½åŠ `);
    setAddProductRow(null);
  };

  // --- Save / Load / Export / Import ---
  const STORAGE_KEY = `james-shelf-${currentFixtureId || 'default'}`;

  const handleSave = () => {
    if (!currentFixtureId) return;
    try {
      // Save to localStorage and update in-memory cache
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ products, deletedProducts, savedAt: new Date().toLocaleString("ja-JP") }));
      if (FIXTURES[currentFixtureId]) {
        FIXTURES[currentFixtureId].products = [...products];
      }
      addLog("æ£šå‰²ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    } catch (err) {
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    }
    setShowSaveMenu(false);
  };

  const handleLoad = () => {
    if (!currentFixtureId) return;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) { alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
      const saveData = JSON.parse(raw);
      setProducts(saveData.products);
      setDeletedProducts(saveData.deletedProducts || []);
      setSelectedProduct(null);
      addLog("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼ã¿ã¾ã—ãŸ (" + saveData.savedAt + ")");
      alert(saveData.savedAt + " ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼ã¿ã¾ã—ãŸ");
    } catch (err) {
      alert("èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    }
    setShowSaveMenu(false);
  };

  const handleReset = () => {
    if (!window.confirm("åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    if (!currentFixtureId) return;
    // Reload from original imported data
    const origFixture = storeDataDefault.fixtures[currentFixtureId];
    if (origFixture) {
      setProducts(origFixture.products || []);
      setDeletedProducts([]);
      setSelectedProduct(null);
      addLog("åˆæœŸãƒ‡ãƒ¼ã‚¿ã«ãƒªã‚»ãƒƒãƒˆ");
      localStorage.removeItem(STORAGE_KEY);
    }
    setShowSaveMenu(false);
  };

  const handleExportJson = () => {
    const exportData = {
      fixtureId: currentFixtureId,
      department: currentFixture?.department || '',
      categoryLabel: currentFixture?.categoryLabel || '',
      shelfWidthMm: currentFixture?.shelfWidthMm || 900,
      rowHeights: currentFixture?.rowHeights || {},
      products: products,
      deletedProducts: deletedProducts,
      exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `james-shelf-${currentFixtureId}-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    addLog("JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†");
    setShowSaveMenu(false);
  };

  const handleImportJson = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const importData = JSON.parse(ev.target.result);
        if (!importData.products || !Array.isArray(importData.products)) {
          alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™"); return;
        }
        if (!window.confirm(`${importData.categoryName || "ä¸æ˜"} ã®æ£šå‰²ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;
        setProducts(importData.products);
        setDeletedProducts(importData.deletedProducts || []);
        setSelectedProduct(null);
        addLog(`JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº† (${importData.exportedAt || "æ—¥æ™‚ä¸æ˜"})`);
      } catch (err) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = "";
    setShowSaveMenu(false);
  };

  const totalOrders = products.filter(p => p.orderQty > 0).length;
  const totalQty = products.reduce((s, p) => s + p.orderQty, 0);

  const goNext = () => {
    if (!selectedProduct) return;
    const sorted = [...products].sort((a, b) => a.row - b.row);
    const idx = sorted.findIndex(p => p.jan === selectedProduct.jan);
    if (idx < sorted.length - 1) setSelectedProduct(sorted[idx + 1]);
  };
  const goPrev = () => {
    if (!selectedProduct) return;
    const sorted = [...products].sort((a, b) => a.row - b.row);
    const idx = sorted.findIndex(p => p.jan === selectedProduct.jan);
    if (idx > 0) setSelectedProduct(sorted[idx - 1]);
  };

  return (
    <div style={{ display: "flex", flexDirection: "column", height: "100vh", background: "#F0F4F8" }}>
      {/* Header */}
      <div style={{ background: `linear-gradient(135deg, ${tc.dark} 0%, ${tc.darkGrad} 100%)`, padding: "10px 16px", display: "flex", alignItems: "center", gap: 10, flexShrink: 0, flexWrap: "wrap", borderBottom: `2px solid ${tc.primary}` }}>
        <div style={{ display: "flex", gap: 6 }}>
          <button onClick={onHome} style={{ ...pillBtnStyle, background: "rgba(255,255,255,0.1)", backdropFilter: "blur(4px)", borderRadius: 8, padding: "6px 12px" }}>TOP</button>
          <button onClick={onBack} style={{ ...pillBtnStyle, background: "rgba(255,255,255,0.1)", backdropFilter: "blur(4px)", borderRadius: 8, padding: "6px 12px" }}>â† å£²å ´</button>
        </div>
        <div style={{ flex: 1, textAlign: "center" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}>
            <span style={{ fontSize: 12, fontWeight: 900, color: tc.primary, letterSpacing: 1 }}>{brand.name}</span>
            <span style={{ color: "#334155", fontSize: 12 }}>|</span>
            <span style={{ color: "#94A3B8", fontSize: 10, fontWeight: 500 }}>ä»€å™¨</span>
            <span style={{ color: "#FFF", fontWeight: 800, fontSize: 15 }}>
              {data.fixture}ï¼š{data.categoryName}
            </span>
          </div>
        </div>
        <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
          <button onClick={() => setEditMode(!editMode)} style={{
            border: "none", borderRadius: 8, padding: "6px 14px", fontSize: 11, cursor: "pointer", fontWeight: 700, transition: "all 0.2s",
            background: editMode ? "linear-gradient(135deg, #F59E0B, #D97706)" : "rgba(255,255,255,0.1)",
            color: editMode ? "#FFF" : "#CBD5E1"
          }}>{editMode ? "ç·¨é›†ä¸­" : terms.shelfEdit}</button>
          {editMode && (
            <div style={{ display: "flex", gap: 2 }}>
              <button onClick={handleUndo} disabled={!canUndo} style={{
                border: "none", borderRadius: 6, padding: "6px 10px", fontSize: 13, cursor: canUndo ? "pointer" : "default",
                background: canUndo ? "rgba(255,255,255,0.15)" : "rgba(255,255,255,0.05)",
                color: canUndo ? "#FFF" : "#475569", fontWeight: 700, transition: "all 0.2s"
              }} title="å…ƒã«æˆ»ã™">â†©</button>
              <button onClick={handleRedo} disabled={!canRedo} style={{
                border: "none", borderRadius: 6, padding: "6px 10px", fontSize: 13, cursor: canRedo ? "pointer" : "default",
                background: canRedo ? "rgba(255,255,255,0.15)" : "rgba(255,255,255,0.05)",
                color: canRedo ? "#FFF" : "#475569", fontWeight: 700, transition: "all 0.2s"
              }} title="ã‚„ã‚Šç›´ã—">â†ª</button>
            </div>
          )}
          {features.dcs && <button onClick={() => setShowDcsPanel(!showDcsPanel)} style={{
            border: "none", borderRadius: 8, padding: "6px 14px", fontSize: 11, cursor: "pointer", fontWeight: 700, transition: "all 0.2s",
            background: showDcsPanel ? `linear-gradient(135deg, ${tc.primary}, ${tc.primaryDark})` : "rgba(255,255,255,0.1)",
            color: "#FFF", position: "relative"
          }}>
            {terms.dcsProposal.replace("ææ¡ˆ","").replace("æŒ‡ç¤º","")}
            {dcsProposals.length > 0 && (
              <span style={{ position: "absolute", top: -4, right: -4, background: tc.danger, color: "#FFF", borderRadius: 8, padding: "1px 5px", fontSize: 9, fontWeight: 800, minWidth: 16, textAlign: "center" }}>{dcsProposals.length}</span>
            )}
          </button>}
          {/* ä¿å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
          <div style={{ position: "relative" }}>
            <button onClick={() => setShowSaveMenu(!showSaveMenu)} style={{
              border: "none", borderRadius: 8, padding: "6px 14px", fontSize: 11, cursor: "pointer", fontWeight: 700,
              background: showSaveMenu ? "linear-gradient(135deg, #10B981, #059669)" : "rgba(255,255,255,0.1)",
              color: showSaveMenu ? "#FFF" : "#CBD5E1", transition: "all 0.2s"
            }}>ğŸ’¾</button>
            {showSaveMenu && (
              <div style={{
                position: "absolute", top: "100%", right: 0, marginTop: 4, background: "#FFF", borderRadius: 10,
                boxShadow: "0 10px 40px rgba(0,0,0,0.2)", padding: 4, zIndex: 100, minWidth: 160
              }}>
                {[
                  { label: "ä¿å­˜", icon: "ğŸ’¾", fn: handleSave },
                  { label: "èª­è¾¼", icon: "ğŸ“‚", fn: handleLoad },
                  { label: "ãƒªã‚»ãƒƒãƒˆ", icon: "ğŸ”„", fn: handleReset },
                  { label: "JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", icon: "ğŸ“¤", fn: handleExportJson },
                  { label: "JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ", icon: "ğŸ“¥", fn: () => fileInputRef.current?.click() },
                  { label: "CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", icon: "ğŸ“Š", fn: () => {
                    const origFixture = storeDataDefault.fixtures?.[currentFixtureId];
                    const csv = exportShelfCSV(products, deletedProducts, currentFixtureId, origFixture?.products);
                    downloadCSV(csv, `james-shelf-${currentFixtureId}-${new Date().toISOString().slice(0,10)}.csv`);
                    addLog("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†");
                    setShowSaveMenu(false);
                  }},
                  { label: "CSVå…¨ã‚´ãƒ³ãƒ‰ãƒ©", icon: "ğŸ“‹", fn: () => {
                    const csv = exportAllFixturesCSV(FIXTURES);
                    downloadCSV(csv, `james-all-fixtures-${new Date().toISOString().slice(0,10)}.csv`);
                    addLog("å…¨ã‚´ãƒ³ãƒ‰ãƒ©CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†");
                    setShowSaveMenu(false);
                  }},
                ].map((item, i) => (
                  <button key={i} onClick={item.fn} style={{
                    display: "block", width: "100%", textAlign: "left", padding: "8px 12px", border: "none",
                    background: "transparent", fontSize: 12, cursor: "pointer", borderRadius: 6,
                    fontWeight: 600, color: "#334155"
                  }} onMouseEnter={e => e.target.style.background = "#F1F5F9"}
                     onMouseLeave={e => e.target.style.background = "transparent"}>
                    {item.icon} {item.label}
                  </button>
                ))}
              </div>
            )}
            <input ref={fileInputRef} type="file" accept=".json" style={{ display: "none" }} onChange={handleImportJson} />
          </div>
          {totalOrders > 0 && (
            <div style={{ background: "linear-gradient(135deg, #0284C7, #0891B2)", color: "#FFF", borderRadius: 20, padding: "5px 14px", fontSize: 12, fontWeight: 700, boxShadow: "0 2px 8px rgba(8,145,178,0.3)" }}>
              ç™ºæ³¨ {totalOrders}å“/{totalQty}å€‹
            </div>
          )}
        </div>
      </div>

      {/* DCSæŒ‡ç¤ºã‚µãƒãƒªãƒ¼ãƒãƒ¼ */}
      {(dcsCutCount > 0 || dcsFaceChangeCount > 0 || dcsSwapCount > 0) && (
        <div style={{ background: "#F8FAFC", borderBottom: "1px solid #E2E8F0", padding: "6px 12px", display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap", fontSize: 11 }}>
          <span style={{ fontWeight: 700, color: "#1B2A4A", fontSize: 11 }}>DCSæŒ‡ç¤º:</span>
          {dcsCutCount > 0 && (
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <span style={{ background: dcsCutRemaining === 0 ? "#D1FAE5" : "#FEE2E2", color: dcsCutRemaining === 0 ? "#065F46" : "#991B1B", padding: "2px 8px", borderRadius: 10, fontWeight: 600, fontSize: 11 }}>
                ã‚«ãƒƒãƒˆæŒ‡ç¤º {dcsCutCount}ä»¶
              </span>
              {dcsCutRemaining === 0
                ? <span style={{ color: "#059669", fontWeight: 700, fontSize: 11 }}>âœ“ å®Œäº†</span>
                : <span style={{ color: "#DC2626", fontSize: 10 }}>æ®‹{dcsCutRemaining}ä»¶</span>
              }
              {dcsCutRemaining === 0 && !taskCompleted["ã‚«ãƒƒãƒˆæŒ‡ç¤º"] && (
                <button onClick={() => markTaskDone("ã‚«ãƒƒãƒˆæŒ‡ç¤º")} style={{ background: "#059669", color: "#FFF", border: "none", borderRadius: 4, padding: "1px 6px", fontSize: 9, cursor: "pointer", fontWeight: 600 }}>ç¢ºèªæ¸ˆ</button>
              )}
              {taskCompleted["ã‚«ãƒƒãƒˆæŒ‡ç¤º"] && <span style={{ color: "#059669", fontSize: 9, fontWeight: 700, background: "#D1FAE5", padding: "1px 6px", borderRadius: 4 }}>ä½œæ¥­å®Œäº†</span>}
            </div>
          )}
          {dcsFaceChangeCount > 0 && (
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <span style={{ background: dcsFaceRemaining === 0 ? "#DBEAFE" : "#FEF3C7", color: dcsFaceRemaining === 0 ? "#1E40AF" : "#92400E", padding: "2px 8px", borderRadius: 10, fontWeight: 600, fontSize: 11 }}>
                ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´ {dcsFaceChangeCount}ä»¶
              </span>
              {dcsFaceRemaining === 0
                ? <span style={{ color: "#2563EB", fontWeight: 700, fontSize: 11 }}>âœ“ å®Œäº†</span>
                : <span style={{ color: "#D97706", fontSize: 10 }}>æ®‹{dcsFaceRemaining}ä»¶</span>
              }
              {dcsFaceRemaining === 0 && !taskCompleted["ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´"] && (
                <button onClick={() => markTaskDone("ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´")} style={{ background: "#2563EB", color: "#FFF", border: "none", borderRadius: 4, padding: "1px 6px", fontSize: 9, cursor: "pointer", fontWeight: 600 }}>ç¢ºèªæ¸ˆ</button>
              )}
              {taskCompleted["ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´"] && <span style={{ color: "#2563EB", fontSize: 9, fontWeight: 700, background: "#DBEAFE", padding: "1px 6px", borderRadius: 4 }}>ä½œæ¥­å®Œäº†</span>}
            </div>
          )}
          {dcsSwapCount > 0 && (
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <span style={{ background: "#E0E7FF", color: "#3730A3", padding: "2px 8px", borderRadius: 10, fontWeight: 600, fontSize: 11 }}>
                å•†å“å…¥æ›¿ {dcsSwapCount}ä»¶
              </span>
              {!taskCompleted["å•†å“å…¥æ›¿"] && (
                <button onClick={() => markTaskDone("å•†å“å…¥æ›¿")} style={{ background: "#4F46E5", color: "#FFF", border: "none", borderRadius: 4, padding: "1px 6px", fontSize: 9, cursor: "pointer", fontWeight: 600 }}>ç¢ºèªæ¸ˆ</button>
              )}
              {taskCompleted["å•†å“å…¥æ›¿"] && <span style={{ color: "#4F46E5", fontSize: 9, fontWeight: 700, background: "#E0E7FF", padding: "1px 6px", borderRadius: 4 }}>ä½œæ¥­å®Œäº†</span>}
            </div>
          )}
          {/* å…¨ä½œæ¥­å®Œäº†ãƒã‚§ãƒƒã‚¯ */}
          {dcsCutRemaining === 0 && dcsFaceRemaining === 0 && (
            <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 4 }}>
              {taskCompleted["ã‚«ãƒƒãƒˆæŒ‡ç¤º"] && taskCompleted["ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´"]
                ? <span style={{ background: "#059669", color: "#FFF", padding: "3px 10px", borderRadius: 12, fontWeight: 700, fontSize: 11 }}>å…¨ä½œæ¥­å®Œäº†</span>
                : <span style={{ color: "#64748B", fontSize: 10 }}>å…¨æŒ‡ç¤ºã®æ‰¿èª/å´ä¸‹ã‚’å®Œäº†å¾Œã€Œç¢ºèªæ¸ˆã€ã§ä½œæ¥­å®Œäº†</span>
              }
            </div>
          )}
        </div>
      )}

      {/* Edit mode banner */}
      {editMode && (
        <div style={{ background: "#FFFBEB", borderBottom: "2px solid #F59E0B", padding: "6px 16px", fontSize: 11, color: "#92400E", display: "flex", alignItems: "center", gap: 8 }}>
          <strong>æ£šå‰²ç·¨é›†</strong>
          <span>ãƒ‰ãƒ©ãƒƒã‚°ï¼ä½ç½®å¤‰æ›´ / FÂ±ï¼ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°ï¼ˆ0ã«ã™ã‚‹ã¨ã‚«ãƒƒãƒˆï¼‰/ å³ãƒ‘ãƒãƒ«ã§å…¥æ›¿ãƒ»å‰Šé™¤</span>
        </div>
      )}

      {/* Store Info Header */}
      <div style={{ background: "#F8FAFC", borderBottom: "1px solid #E2E8F0", padding: "8px 12px", fontSize: 11, color: "#64748B" }}>
        {STORE_INFO.company} {STORE_INFO.storeName}åº— | å®Ÿç¸¾æœŸé–“: {new Date(STORE_INFO.periodFrom.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')).toLocaleDateString("ja-JP")} - {new Date(STORE_INFO.periodTo.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')).toLocaleDateString("ja-JP")} ({STORE_INFO.periodDays}æ—¥é–“)
      </div>

      {/* Fixture Selector Row */}
      <div style={{ display: "flex", background: "#F8FAFC", borderBottom: "1px solid #E2E8F0", flexShrink: 0, overflowX: "auto", padding: "8px 12px", gap: 8, alignItems: "center" }}>
        <span style={{ fontSize: 11, fontWeight: 700, color: "#64748B", minWidth: 60 }}>ã‚´ãƒ³ãƒ‰ãƒ©:</span>
        {gondolaCodes.map(gondolaCode => {
          const fixture = FIXTURES[gondolaCode];
          if (!fixture) return null;
          const categoryLabel = fixture.categoryLabel || `${fixture.categories?.join(' / ') || gondolaCode}`;
          return (
            <button key={gondolaCode} onClick={() => setCurrentFixtureId(gondolaCode)} style={{
              padding: "6px 14px", borderRadius: 20, border: currentFixtureId === gondolaCode ? "2px solid #0891B2" : "1px solid #CBD5E1",
              background: currentFixtureId === gondolaCode ? "#DBEAFE" : "#FFF",
              color: currentFixtureId === gondolaCode ? "#0891B2" : "#64748B",
              cursor: "pointer", fontSize: 11, fontWeight: 600, whiteSpace: "nowrap",
              transition: "all 0.2s"
            }}>{gondolaCode} {categoryLabel}</button>
          );
        })}
      </div>

      {/* View mode tabs - context-dependent */}
      <div style={{ display: "flex", background: "#FFF", borderBottom: "1px solid #E2E8F0", flexShrink: 0, overflowX: "auto" }}>
        {(currentFixture?.fixtureType === "gondola" ? [
          { key: "shelf", label: "æ£šå‰²" },
          { key: "list", label: "ä¸€è¦§" },
          { key: "priority", label: "é‡ç‚¹" },
          { key: "gondola-metrics", label: "ã‚´ãƒ³ãƒ‰ãƒ©åˆ†æ" },
        ] : [
          { key: "shelf", label: "ã‚¨ãƒ³ãƒ‰é™³åˆ—" },
          { key: "gondola-metrics", label: "åˆ†æ" },
        ]).map(t => (
          <button key={t.key} onClick={() => setViewMode(t.key)} style={{
            flex: 1, minWidth: 80, padding: "10px 0", border: "none", cursor: "pointer", fontSize: 13, fontWeight: 600,
            background: viewMode === t.key ? "#0891B2" : "#FFF",
            color: viewMode === t.key ? "#FFF" : "#64748B",
            borderBottom: viewMode === t.key ? "3px solid #0891B2" : "3px solid transparent",
            whiteSpace: "nowrap"
          }}>{t.label}</button>
        ))}
      </div>

      {/* Main content */}
      <div style={{ flex: 1, display: "flex", overflow: "hidden" }}>
        {/* Left side */}
        <div style={{ flex: 1, overflow: "auto", padding: 8 }}>
          {/* Loading indicator */}
          {fixtureLoading && (
            <div style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 40 }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ width: 32, height: 32, border: "3px solid #E2E8F0", borderTop: "3px solid #0891B2", borderRadius: "50%", animation: "spin 1s linear infinite", margin: "0 auto 8px" }} />
                <div style={{ fontSize: 12, color: "#64748B" }}>ã‚´ãƒ³ãƒ‰ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
              </div>
            </div>
          )}

          {/* DCS panel at top if open */}
          {!fixtureLoading && currentFixture && showDcsPanel && (
            <div style={{ marginBottom: 10 }}>
              <DcsProposalPanel proposals={dcsProposals} products={products} onApprove={handleDcsApprove} onReject={handleDcsReject} />
            </div>
          )}

          {!fixtureLoading && currentFixture && currentFixture.fixtureType === "gondola" && viewMode === "shelf" && (
            <div ref={shelfGridRef} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
              <ShelfGrid products={products} selected={selectedProduct} onSelect={setSelectedProduct}
                editMode={editMode} onFaceChange={handleFaceChange} onDragStart={handleDragStart} onDrop={handleDrop} dragItem={dragItem}
                onDelete={handleDeleteProduct} deletedProducts={deletedProducts} onRestore={handleRestoreProduct}
                shelfWidthMm={currentFixture.shelfWidthMm || 900} rowHeights={currentFixture.rowHeights || {}}
                onTouchStart={handleTouchStart} onAddProduct={(row) => setAddProductRow(row)} promotionalSlots={currentFixture.promotionalSlots || []} />
            </div>
          )}
          {!fixtureLoading && currentFixture && currentFixture.fixtureType === "endcap" && viewMode === "shelf" && (
            <EndCapView endCap={currentFixture} editMode={editMode} onProductSelect={setSelectedProduct} selected={selectedProduct} />
          )}
          {!fixtureLoading && currentFixture && currentFixture.fixtureType === "gondola" && viewMode === "list" && (
            <ListView products={products} selected={selectedProduct} onSelect={setSelectedProduct} onOrderChange={handleOrderChange} onDelete={handleDeleteProduct} editMode={editMode} />
          )}
          {!fixtureLoading && currentFixture && currentFixture.fixtureType === "gondola" && viewMode === "priority" && (
            <PriorityView products={products} selected={selectedProduct} onSelect={setSelectedProduct} />
          )}
          {!fixtureLoading && currentFixture && viewMode === "gondola-metrics" && (
            <GondolaMetricsPanel products={products} shelfWidthMm={currentFixture.shelfWidthMm || 900} rowCount={currentFixture.rows || 4} fixtureId={currentFixture.fixtureId} categoryName={currentFixture.categoryName || ''} />
          )}

          {!fixtureLoading && !currentFixture && (
            <div style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 40, color: "#94A3B8", fontSize: 13 }}>
              ã‚´ãƒ³ãƒ‰ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„
            </div>
          )}
        </div>

        {/* Right: Detail Panel */}
        {selectedProduct && (
          <div style={{ width: 340, borderLeft: "1px solid #E2E8F0", background: "#FFF", display: "flex", flexDirection: "column", flexShrink: 0, overflow: "hidden" }}>
            <div style={{ padding: "10px 12px", background: "#F8FAFC", borderBottom: "1px solid #E2E8F0" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: "#1B2A4A" }}>{selectedProduct.name}</div>
                <button onClick={() => setSelectedProduct(null)} style={{ background: "none", border: "none", fontSize: 18, cursor: "pointer", color: "#94A3B8" }}>Ã—</button>
              </div>
              <div style={{ fontSize: 11, color: "#64748B", marginTop: 2 }}>
                {selectedProduct.maker}ã€€|ã€€Â¥{selectedProduct.price}ã€€|ã€€ãƒ©ãƒ³ã‚¯ {selectedProduct.rank}
              </div>
              <div style={{ fontSize: 10, color: "#94A3B8", marginTop: 2 }}>
                JAN: {selectedProduct.jan}ã€€|ã€€{selectedProduct.row}æ®µã€€F:{selectedProduct.face}ã€€å¹…{(selectedProduct.width_mm||90)*selectedProduct.face}mm
              </div>
              {editMode && (
                <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
                  <button onClick={() => setShowSwapDialog(true)} style={{ background: "#F59E0B", color: "#FFF", border: "none", borderRadius: 6, padding: "4px 12px", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>å•†å“å…¥æ›¿</button>
                  <button onClick={() => handleDeleteProduct(selectedProduct.jan)} style={{ background: "#D63031", color: "#FFF", border: "none", borderRadius: 6, padding: "4px 12px", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>ã‚«ãƒƒãƒˆï¼ˆå‰Šé™¤ï¼‰</button>
                </div>
              )}
            </div>
            <div style={{ display: "flex", borderBottom: "1px solid #E2E8F0", flexShrink: 0 }}>
              {[
                { key: "order", label: "ç™ºæ³¨" },
                { key: "params", label: "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿" },
                { key: "chart", label: "å®Ÿç¸¾" },
                { key: "profit", label: "åç›Š" },
                { key: "info", label: "æƒ…å ±" },
              ].map(t => (
                <button key={t.key} onClick={() => setDetailTab(t.key)} style={{
                  flex: 1, padding: "8px 0", border: "none", cursor: "pointer", fontSize: 10, fontWeight: 600,
                  background: detailTab === t.key ? "#0891B2" : "#FFF",
                  color: detailTab === t.key ? "#FFF" : "#64748B",
                }}>{t.label}</button>
              ))}
            </div>
            <div style={{ flex: 1, overflow: "auto", padding: 12 }}>
              {detailTab === "order" && <OrderPanel product={selectedProduct} onOrderChange={handleOrderChange} onNext={goNext} onPrev={goPrev} />}
              {detailTab === "params" && <ParamsPanel product={selectedProduct} onParamChange={handleParamChange} onParamChangeBatch={handleParamChangeBatch} rowHeights={currentFixture?.rowHeights || {}} />}
              {detailTab === "chart" && <ChartPanel product={selectedProduct} />}
              {detailTab === "profit" && <ProfitPanel product={selectedProduct} allProducts={products} />}
              {detailTab === "info" && <InfoPanel product={selectedProduct} />}
            </div>
          </div>
        )}
      </div>

      {/* Footer */}
      <div style={{ background: "linear-gradient(135deg, #0F172A 0%, #1E293B 100%)", padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexShrink: 0, borderTop: "1px solid #334155" }}>
        <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <span style={{ fontSize: 10, color: "#64748B" }}>SKU</span>
            <span style={{ fontSize: 13, fontWeight: 700, color: "#FFF" }}>{products.length}</span>
          </div>
          <div style={{ width: 1, height: 16, background: "#334155" }} />
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <span style={{ fontSize: 10, color: "#64748B" }}>ä¸è¶³</span>
            <span style={{ fontSize: 13, fontWeight: 700, color: products.filter(p => p.currentStock <= p.orderPoint).length > 0 ? "#F87171" : "#10B981" }}>
              {products.filter(p => p.currentStock <= p.orderPoint).length}
            </span>
          </div>
          {deletedProducts.length > 0 && (
            <>
              <div style={{ width: 1, height: 16, background: "#334155" }} />
              <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                <span style={{ fontSize: 10, color: "#64748B" }}>ã‚«ãƒƒãƒˆ</span>
                <span style={{ fontSize: 13, fontWeight: 700, color: "#F87171" }}>{deletedProducts.length}</span>
              </div>
            </>
          )}
          {changeLog.length > 0 && (
            <>
              <div style={{ width: 1, height: 16, background: "#334155" }} />
              <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                <span style={{ fontSize: 10, color: "#64748B" }}>å¤‰æ›´</span>
                <span style={{ fontSize: 13, fontWeight: 700, color: "#FBBF24" }}>{changeLog.length}</span>
              </div>
            </>
          )}
        </div>
        <button style={{
          background: totalOrders > 0 ? `linear-gradient(135deg, ${tc.primaryDark}, ${tc.primary})` : "#334155",
          color: "#FFF", border: "none", borderRadius: 10,
          padding: "10px 28px", fontWeight: 700, fontSize: 14, cursor: totalOrders > 0 ? "pointer" : "default",
          boxShadow: totalOrders > 0 ? `0 4px 12px ${tc.primary}4D` : "none",
          transition: "all 0.2s"
        }}>
          {terms.orderConfirm}ï¼ˆ{totalOrders}å“/{totalQty}å€‹ï¼‰
        </button>
      </div>

      {/* Dialogs */}
      {showSwapDialog && selectedProduct && (
        <ProductSwapDialog currentProduct={selectedProduct} candidates={CANDIDATE_PRODUCTS} onSwap={handleProductSwap} onClose={() => setShowSwapDialog(false)} />
      )}
      {addProductRow !== null && (
        <AddProductDialog
          row={addProductRow}
          candidates={CANDIDATE_PRODUCTS}
          existingJans={products.map(p => p.jan)}
          onAdd={handleAddProduct}
          onClose={() => setAddProductRow(null)}
          shelfWidthMm={currentFixture?.shelfWidthMm || 900}
          currentRowWidth={calcRowWidth(products, addProductRow)}
        />
      )}
    </div>
  );
};

// ============================================================
// SHELF GRID - ã‚´ãƒ³ãƒ‰ãƒ©ä»€å™¨é¢¨ ãƒªã‚¢ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
// ============================================================
const ShelfGrid = ({ products, selected, onSelect, editMode, onFaceChange, onDragStart, onDrop, dragItem, onDelete, deletedProducts, onRestore, shelfWidthMm, rowHeights, onTouchStart: parentTouchStart, onAddProduct, promotionalSlots }) => {
  const rows = [1, 2, 3, 4];
  const totalShelfMm = shelfWidthMm || 900;
  const rh = rowHeights || { 1: 280, 2: 300, 3: 280, 4: 320 };
  const mmToPx = (mm) => Math.round((mm / 320) * 140);

  // æ®µãƒ©ãƒ™ãƒ«ã®åå‰
  const rowLabels = { 1: "ä¸Šæ®µ", 2: "ä¸­ä¸Šæ®µ", 3: "ä¸­ä¸‹æ®µ", 4: "ä¸‹æ®µ" };

  return (
    <div style={{ background: "#FFF", borderRadius: 12, border: "1px solid #E2E8F0", overflow: "hidden", boxShadow: "0 4px 20px rgba(0,0,0,0.08)" }}>
      {/* ã‚´ãƒ³ãƒ‰ãƒ©ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div style={{ background: "linear-gradient(135deg, #1E293B 0%, #334155 100%)", padding: "10px 16px", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <div style={{ width: 8, height: 8, borderRadius: 4, background: "#10B981" }} />
          <span style={{ color: "#FFF", fontSize: 12, fontWeight: 700 }}>ã‚´ãƒ³ãƒ‰ãƒ©ä»€å™¨</span>
          <span style={{ color: "#94A3B8", fontSize: 11 }}>{totalShelfMm}mmå¹… Ã— {rows.length}æ®µ</span>
        </div>
        <div style={{ color: "#64748B", fontSize: 10 }}>
          {products.length} SKU
        </div>
      </div>

      {/* æ£šæœ¬ä½“ */}
      <div style={{ padding: "0 2px", background: "linear-gradient(180deg, #F8FAFC 0%, #EFF3F8 100%)" }}>
        {rows.map(row => {
          const rowProducts = products.filter(p => p.row === row);
          const usedMm = calcRowWidth(products, row);
          const freeMm = totalShelfMm - usedMm;
          const overflowing = freeMm < 0;
          const freePercent = Math.max(0, (freeMm / totalShelfMm) * 100);
          const fillPct = Math.min(100, (usedMm / totalShelfMm) * 100);

          return (
            <div key={row}>
              {/* æ®µãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div style={{ display: "flex", alignItems: "center", padding: "6px 10px 2px", gap: 8 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 4, minWidth: 70 }}>
                  <span style={{ fontSize: 12, fontWeight: 800, color: "#1E293B" }}>{row}</span>
                  <span style={{ fontSize: 10, color: "#64748B", fontWeight: 500 }}>{rowLabels[row]}</span>
                  <span style={{ fontSize: 9, color: "#94A3B8" }}>{rh[row]}mm</span>
                </div>
                {/* ä½¿ç”¨ç‡ãƒãƒ¼ */}
                <div style={{ flex: 1, display: "flex", alignItems: "center", gap: 6 }}>
                  <div style={{ flex: 1, height: 4, background: "#E2E8F0", borderRadius: 2, overflow: "hidden" }}>
                    <div style={{
                      height: 4, borderRadius: 2, transition: "width 0.3s",
                      width: `${fillPct}%`,
                      background: overflowing ? "#EF4444" : freeMm < 50 ? "#F59E0B" : "#10B981"
                    }} />
                  </div>
                  <span style={{
                    fontSize: 9, whiteSpace: "nowrap", fontWeight: 600,
                    color: overflowing ? "#EF4444" : freeMm < 50 ? "#D97706" : "#64748B"
                  }}>
                    {overflowing ? `${Math.abs(freeMm)}mmè¶…é` : `ç©º${freeMm}mm`}
                  </span>
                </div>
              </div>

              {/* å•†å“ã‚»ãƒ« */}
              <div style={{ display: "flex", padding: "0 6px 0 6px", alignItems: "flex-end" }}>
                <div style={{ flex: 1, display: "flex", gap: 2, alignItems: "flex-end" }}>
                  {rowProducts.map((p, idx) => {
                    const cellWidthMm = (p.width_mm || 90) * p.face;
                    const widthPercent = (cellWidthMm / totalShelfMm) * 100;
                    const rowH = rh[row] || 300;
                    const prodH = p.height_mm || 200;
                    const maxStack = calcMaxStack(prodH, rowH);
                    const cellHeightPx = mmToPx(rowH);
                    const prodHeightPct = Math.min(100, (prodH / rowH) * 100);
                    const isSelected = selected?.jan === p.jan;
                    const isLow = p.currentStock <= p.orderPoint;
                    const isDragging = dragItem?.jan === p.jan;
                    const dcsProposal = DCS_PROPOSALS.find(d => d.jan === p.jan && d.fixtureId === currentFixtureId);
                    const isCutOrReduce = dcsProposal && (dcsProposal.action === "ã‚«ãƒƒãƒˆ" || dcsProposal.action === "ãƒ•ã‚§ãƒ¼ã‚¹æ¸›");
                    const isIncrease = dcsProposal && dcsProposal.action === "ãƒ•ã‚§ãƒ¼ã‚¹å¢—";

                    return (
                      <div key={p.jan}
                        data-drop-row={row} data-drop-idx={idx}
                        draggable={editMode}
                        onDragStart={editMode ? () => onDragStart(p) : undefined}
                        onDragOver={editMode ? e => e.preventDefault() : undefined}
                        onDrop={editMode ? () => onDrop(row, idx) : undefined}
                        onTouchStart={editMode && parentTouchStart ? (e) => parentTouchStart(p, e) : undefined}
                        onClick={() => onSelect(p)}
                        style={{
                          position: "relative", height: cellHeightPx,
                          width: `${widthPercent}%`, minWidth: 54, flexShrink: 0,
                          background: isDragging ? "#FEF3C7" : isSelected ? "linear-gradient(180deg, #DBEAFE 0%, #EFF6FF 100%)" : "linear-gradient(180deg, #FFFFFF 0%, #F8FAFC 100%)",
                          border: isSelected ? "2px solid #0284C7" : isCutOrReduce ? "2px solid #DC2626" : isIncrease ? "2px solid #2563EB" : isLow ? "2px solid #F87171" : "1px solid #E2E8F0",
                          borderRadius: 8, cursor: editMode ? "grab" : "pointer", padding: "4px 5px", textAlign: "left",
                          boxShadow: isSelected ? "0 0 0 3px rgba(2,132,199,0.15), 0 4px 12px rgba(0,0,0,0.1)" : "0 1px 3px rgba(0,0,0,0.06)",
                          transition: "all 0.2s ease", overflow: "hidden", opacity: isDragging ? 0.4 : 1
                        }}>
                        {/* å•†å“é«˜ã•ãƒãƒ¼ */}
                        <div style={{
                          position: "absolute", left: 1, bottom: 1, width: 3, borderRadius: 2,
                          height: `${prodHeightPct}%`,
                          background: maxStack >= 3 ? "#10B981" : maxStack >= 2 ? "#0891B2" : "#CBD5E1",
                          opacity: 0.5
                        }} />
                        {maxStack > 1 && (
                          <span style={{ position: "absolute", left: 6, bottom: 2, fontSize: 7, color: "#0891B2", fontWeight: 700, opacity: 0.8 }}>Ã—{maxStack}</span>
                        )}
                        {/* DCS ã‚«ãƒƒãƒˆ/ãƒ•ã‚§ãƒ¼ã‚¹æ¸› */}
                        {isCutOrReduce && (
                          <div style={{
                            position: "absolute", top: 0, left: 0, right: 0, bottom: 0, borderRadius: 7, zIndex: 2, pointerEvents: "none",
                            background: "repeating-linear-gradient(135deg, transparent, transparent 4px, rgba(220,38,38,0.2) 4px, rgba(220,38,38,0.2) 6px)"
                          }}>
                            <div style={{
                              position: "absolute", bottom: 3, left: 3, right: 3, background: "#DC2626",
                              color: "#FFF", fontSize: 8, fontWeight: 800, textAlign: "center", borderRadius: 4, padding: "2px 0", letterSpacing: 0.5
                            }}>{dcsProposal.action === "ã‚«ãƒƒãƒˆ" ? "ã‚«ãƒƒãƒˆ" : "Fæ¸›"}</div>
                          </div>
                        )}
                        {/* DCS ãƒ•ã‚§ãƒ¼ã‚¹å¢— */}
                        {isIncrease && (
                          <div style={{
                            position: "absolute", top: 0, left: 0, right: 0, bottom: 0, borderRadius: 7, zIndex: 2, pointerEvents: "none",
                            background: "repeating-linear-gradient(135deg, transparent, transparent 4px, rgba(37,99,235,0.15) 4px, rgba(37,99,235,0.15) 6px)"
                          }}>
                            <div style={{
                              position: "absolute", bottom: 3, left: 3, right: 3, background: "#2563EB",
                              color: "#FFF", fontSize: 8, fontWeight: 800, textAlign: "center", borderRadius: 4, padding: "2px 0", letterSpacing: 0.5
                            }}>Få¢—</div>
                          </div>
                        )}
                        {/* Promotional slot marker */}
                        {promotionalSlots && promotionalSlots.find(s => s.jan === p.jan) && (
                          <div style={{
                            position: "absolute", top: 0, left: 0, right: 0, bottom: 0, borderRadius: 7, zIndex: 1, pointerEvents: "none",
                            border: "2px solid #F59E0B", background: "rgba(245,158,11,0.05)"
                          }}>
                            <div style={{
                              position: "absolute", top: 3, left: 3, background: "#F59E0B",
                              color: "#FFF", fontSize: 7, fontWeight: 800, borderRadius: 3, padding: "1px 4px"
                            }}>è²©ä¿ƒ</div>
                          </div>
                        )}
                        <RankBadge rank={p.rank} />
                        <TagBadge tag={p.tag} />
                        <div style={{ marginTop: 20, fontSize: 10, color: "#1E293B", fontWeight: 600, lineHeight: "13px", overflow: "hidden", height: 26 }}>
                          {p.name.length > (p.face > 1 ? 20 : 10) ? p.name.slice(0, p.face > 1 ? 20 : 10) + "â€¦" : p.name}
                        </div>
                        <div style={{ fontSize: 8, color: "#94A3B8", letterSpacing: 0.3, marginTop: -1 }}>{p.jan.slice(-4)}</div>
                        <StockBar current={p.currentStock} base={p.baseStock} orderPoint={p.orderPoint} />
                        <div style={{ display: "flex", justifyContent: "space-between", marginTop: 2, alignItems: "center" }}>
                          <span style={{ fontSize: 8, color: isLow ? "#DC2626" : "#64748B", fontWeight: isLow ? 700 : 400 }}>åœ¨åº«{p.currentStock}</span>
                          {p.orderQty > 0 && (
                            <span style={{ fontSize: 9, fontWeight: 800, color: "#FFF", background: "#0284C7", borderRadius: 3, padding: "0 4px" }}>
                              {p.orderQty}
                            </span>
                          )}
                        </div>
                        {/* Facing bar & edit */}
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 1 }}>
                          <span style={{ fontSize: 9, fontWeight: 700, color: "#0284C7" }}>
                            F:{p.face}
                            <span style={{ fontSize: 8, color: "#94A3B8", fontWeight: 400, marginLeft: 2 }}>{cellWidthMm}mm</span>
                          </span>
                          {editMode && (
                            <div style={{ display: "flex", gap: 1 }} onClick={e => e.stopPropagation()}>
                              <button onClick={e => { e.stopPropagation(); onFaceChange(p.jan, p.face - 1); }}
                                style={{ width: 18, height: 18, fontSize: 11, border: "1px solid #CBD5E1", borderRadius: 4, background: p.face <= 1 ? "#FEF2F2" : "#FFF", cursor: "pointer", padding: 0, lineHeight: "16px", color: p.face <= 1 ? "#DC2626" : "#1E293B", fontWeight: 600 }}>âˆ’</button>
                              <button onClick={e => { e.stopPropagation(); onFaceChange(p.jan, p.face + 1); }}
                                style={{ width: 18, height: 18, fontSize: 11, border: "1px solid #CBD5E1", borderRadius: 4, background: "#FFF", cursor: "pointer", padding: 0, lineHeight: "16px", fontWeight: 600 }}>+</button>
                              <button onClick={e => { e.stopPropagation(); onDelete(p.jan); }}
                                style={{ width: 18, height: 18, fontSize: 11, border: "1px solid #DC2626", borderRadius: 4, background: "#FEF2F2", cursor: "pointer", padding: 0, lineHeight: "16px", color: "#DC2626", fontWeight: 600 }}>Ã—</button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                  {/* Free space */}
                  {freeMm > 0 && (
                    <div
                      data-drop-row={row} data-drop-idx={rowProducts.length}
                      style={{
                        width: `${freePercent}%`, minWidth: 30, height: mmToPx(rh[row] || 300),
                        background: editMode && dragItem ? "linear-gradient(180deg, #DBEAFE 0%, #EFF6FF 100%)" : "linear-gradient(180deg, #F8FAFC 0%, #F1F5F9 100%)",
                        borderRadius: 8,
                        border: editMode && dragItem ? "2px dashed #0284C7" : "1px dashed #D1D5DB",
                        display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 4,
                        fontSize: 9, color: editMode && dragItem ? "#0284C7" : "#CBD5E1", flexShrink: 0, fontWeight: 500
                      }}
                      onDragOver={editMode ? e => e.preventDefault() : undefined}
                      onDrop={editMode ? () => onDrop(row, rowProducts.length) : undefined}
                    >
                      {editMode && dragItem ? "ãƒ‰ãƒ­ãƒƒãƒ—" : `${freeMm}mm`}
                      {editMode && !dragItem && onAddProduct && (
                        <button onClick={(e) => { e.stopPropagation(); onAddProduct(row); }} style={{
                          border: "1px dashed #0891B2", borderRadius: 6, background: "rgba(8,145,178,0.08)",
                          color: "#0891B2", fontSize: 10, fontWeight: 700, padding: "4px 10px", cursor: "pointer",
                          transition: "all 0.2s"
                        }}>ï¼‹ è¿½åŠ </button>
                      )}
                    </div>
                  )}
                </div>
              </div>
              {/* æ£šæ¿ï¼ˆã‚´ãƒ³ãƒ‰ãƒ©ä»€å™¨ã®æ£šç·šï¼‰ */}
              <div style={{ margin: "0 6px", height: 4, background: "linear-gradient(180deg, #94A3B8 0%, #CBD5E1 100%)", borderRadius: "0 0 2px 2px", boxShadow: "0 2px 4px rgba(0,0,0,0.1)" }} />
            </div>
          );
        })}
      </div>

      {/* ã‚«ãƒƒãƒˆæ¸ˆã¿å•†å“ */}
      {deletedProducts.length > 0 && (
        <div style={{ margin: "0 12px 12px", padding: "10px 14px", background: "linear-gradient(135deg, #FFF5F5 0%, #FEF2F2 100%)", borderRadius: 8, border: "1px solid #FECACA" }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: "#DC2626", marginBottom: 6, display: "flex", alignItems: "center", gap: 6 }}>
            <span>ã‚«ãƒƒãƒˆæ¸ˆã¿å•†å“</span>
            <span style={{ background: "#DC2626", color: "#FFF", borderRadius: 10, padding: "1px 8px", fontSize: 10 }}>{deletedProducts.length}</span>
          </div>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
            {deletedProducts.map(p => (
              <div key={p.jan} style={{
                display: "flex", alignItems: "center", gap: 6, background: "#FFF", border: "1px solid #FECACA",
                borderRadius: 6, padding: "5px 10px", fontSize: 10, boxShadow: "0 1px 2px rgba(0,0,0,0.04)"
              }}>
                <span style={{ color: "#64748B", fontWeight: 500 }}>{p.name}</span>
                {editMode && (
                  <button onClick={() => onRestore(p.jan)} style={{
                    background: "linear-gradient(135deg, #10B981, #059669)", color: "#FFF", border: "none",
                    borderRadius: 4, padding: "2px 8px", fontSize: 9, cursor: "pointer", fontWeight: 700
                  }}>å¾©å…ƒ</button>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// List View
const ListView = ({ products, selected, onSelect, onOrderChange, onDelete, editMode }) => {
  const sorted = [...products].sort((a, b) => a.row - b.row);
  return (
    <div style={{ overflowX: "auto" }}>
      <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
        <thead>
          <tr style={{ background: "#1B2A4A", color: "#FFF" }}>
            <th style={thStyle}>æ£š</th>
            <th style={{ ...thStyle, textAlign: "left", minWidth: 140 }}>å•†å“å</th>
            <th style={thStyle}>R</th>
            <th style={thStyle}>F</th>
            <th style={thStyle}>åœ¨åº«</th>
            <th style={thStyle}>OP</th>
            <th style={thStyle}>CAP</th>
            {DAYS.map((d, i) => <th key={i} style={thStyle}>{d}</th>)}
            <th style={{ ...thStyle, background: "#0891B2" }}>ç™ºæ³¨</th>
            {editMode && <th style={{ ...thStyle, background: "#D63031" }}>æ“ä½œ</th>}
          </tr>
        </thead>
        <tbody>
          {sorted.map(p => {
            const isSelected = selected?.jan === p.jan;
            const isLow = p.currentStock <= p.orderPoint;
            return (
              <tr key={p.jan} onClick={() => onSelect(p)} style={{
                background: isSelected ? "#DBEAFE" : isLow ? "#FEF2F2" : "#FFF",
                cursor: "pointer", borderBottom: "1px solid #E2E8F0"
              }}>
                <td style={tdStyle}>{p.row}æ®µ</td>
                <td style={{ ...tdStyle, fontWeight: 600, maxWidth: 150 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                    {p.tag && <span style={{ fontSize: 8, background: p.tag === "ãƒãƒ©ã‚·" ? "#EF4444" : p.tag === "è²©ä¿ƒ" ? "#F59E0B" : "#8B5CF6", color: "#FFF", padding: "0 3px", borderRadius: 2 }}>{p.tag}</span>}
                    <span style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{p.name}</span>
                  </div>
                </td>
                <td style={{ ...tdStyle, textAlign: "center" }}>
                  <span style={{ background: p.rank === "A" ? "#0891B2" : p.rank === "B" ? "#F59E0B" : "#94A3B8", color: "#FFF", padding: "1px 5px", borderRadius: 8, fontSize: 10, fontWeight: 700 }}>{p.rank}</span>
                </td>
                <td style={{ ...tdStyle, textAlign: "center", fontWeight: 700, color: "#0891B2" }}>{p.face}</td>
                <td style={{ ...tdStyle, textAlign: "center", color: isLow ? "#EF4444" : "#1B2A4A", fontWeight: isLow ? 700 : 400 }}>{p.currentStock}/{p.baseStock}</td>
                <td style={{ ...tdStyle, textAlign: "center" }}>{p.orderPoint}</td>
                <td style={{ ...tdStyle, textAlign: "center", fontSize: 10, color: "#64748B" }}>{p.cap || "-"}</td>
                {(p.salesWeek || [0,0,0,0,0,0,0]).map((v, i) => <td key={i} style={{ ...tdStyle, textAlign: "center", color: "#64748B" }}>{v}</td>)}
                <td style={{ ...tdStyle, textAlign: "center", padding: "2px 4px" }}>
                  <input type="number" min="0" value={p.orderQty}
                    onChange={e => onOrderChange(p.jan, parseInt(e.target.value) || 0)}
                    onClick={e => e.stopPropagation()}
                    style={{ width: 44, textAlign: "center", border: "1px solid #CBD5E1", borderRadius: 4, padding: "3px 2px", fontSize: 12, fontWeight: 700, color: p.orderQty > 0 ? "#0891B2" : "#1B2A4A", background: p.orderQty > 0 ? "#ECFEFF" : "#FFF" }} />
                </td>
                {editMode && (
                  <td style={{ ...tdStyle, textAlign: "center", padding: "2px 4px" }}>
                    <button onClick={e => { e.stopPropagation(); onDelete(p.jan); }}
                      style={{ background: "#D63031", color: "#FFF", border: "none", borderRadius: 4, padding: "3px 8px", fontSize: 9, fontWeight: 700, cursor: "pointer" }}>ã‚«ãƒƒãƒˆ</button>
                  </td>
                )}
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
};

// Priority View
const PriorityView = ({ products, selected, onSelect }) => {
  const tagged = products.filter(p => p.tag);
  const lowStock = products.filter(p => p.currentStock <= p.orderPoint && !p.tag);
  return (
    <div>
      <div style={{ fontSize: 13, fontWeight: 700, color: "#1B2A4A", padding: "8px 4px" }}>é‡ç‚¹å•†å“</div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 16 }}>
        {tagged.map(p => (
          <button key={p.jan} onClick={() => onSelect(p)} style={{
            background: selected?.jan === p.jan ? "#DBEAFE" : "#FFF",
            border: selected?.jan === p.jan ? "2px solid #0891B2" : "1px solid #E2E8F0",
            borderRadius: 8, padding: 10, cursor: "pointer", textAlign: "left", position: "relative"
          }}>
            <TagBadge tag={p.tag} />
            <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A" }}>{p.name}</div>
            <div style={{ fontSize: 10, color: "#64748B", marginTop: 2 }}>{p.maker}ã€€Â¥{p.price}ã€€F:{p.face}</div>
            <StockBar current={p.currentStock} base={p.baseStock} orderPoint={p.orderPoint} />
          </button>
        ))}
      </div>
      {lowStock.length > 0 && (
        <>
          <div style={{ fontSize: 13, fontWeight: 700, color: "#EF4444", padding: "8px 4px" }}>åœ¨åº«ä¸è¶³</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            {lowStock.map(p => (
              <button key={p.jan} onClick={() => onSelect(p)} style={{
                background: selected?.jan === p.jan ? "#DBEAFE" : "#FEF2F2",
                border: selected?.jan === p.jan ? "2px solid #0891B2" : "1px solid #FCA5A5",
                borderRadius: 8, padding: 10, cursor: "pointer", textAlign: "left"
              }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A" }}>{p.name}</div>
                <StockBar current={p.currentStock} base={p.baseStock} orderPoint={p.orderPoint} />
                <div style={{ fontSize: 9, color: "#EF4444", marginTop: 4, fontWeight: 700 }}>åœ¨åº« {p.currentStock} â‰¤ OP {p.orderPoint}</div>
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  );
};

// ============================================================
// DETAIL PANELS
// ============================================================
const OrderPanel = ({ product, onOrderChange, onNext, onPrev }) => {
  const p = product;
  const isLow = p.currentStock <= p.orderPoint;
  const suggested = Math.max(0, p.baseStock - p.currentStock);
  const avgSales = p.salesWeek ? (p.salesWeek.reduce((a, b) => a + b, 0) / 7) : 0;
  const daysOfStock = avgSales > 0 ? (p.currentStock / avgSales).toFixed(1) : "âˆ";

  return (
    <div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 12 }}>
        <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 10, textAlign: "center" }}>
          <div style={{ fontSize: 10, color: "#94A3B8" }}>ç¾åœ¨åº«</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: isLow ? "#EF4444" : "#1B2A4A" }}>{p.currentStock}</div>
          <div style={{ fontSize: 10, color: "#94A3B8" }}>åŸºæº–{p.baseStock} CAP{p.cap||"-"}</div>
        </div>
        <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 10, textAlign: "center" }}>
          <div style={{ fontSize: 10, color: "#94A3B8" }}>ç™ºæ³¨ç‚¹(OP)</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: "#F59E0B" }}>{p.orderPoint}</div>
          <div style={{ fontSize: 10, color: "#94A3B8" }}>F:{p.face} åœ¨åº«{daysOfStock}æ—¥</div>
        </div>
      </div>

      {isLow && (
        <div style={{ background: "#FEF2F2", border: "1px solid #FCA5A5", borderRadius: 8, padding: 8, marginBottom: 12, fontSize: 11, color: "#EF4444", fontWeight: 600 }}>
          åœ¨åº«ä¸è¶³ã€‚æ¨å¥¨ç™ºæ³¨æ•°: {suggested}
        </div>
      )}

      <div style={{ background: "#ECFEFF", borderRadius: 12, padding: 16, textAlign: "center", marginBottom: 12 }}>
        <div style={{ fontSize: 11, color: "#0891B2", fontWeight: 600, marginBottom: 6 }}>ç™ºæ³¨æ•°é‡</div>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 12 }}>
          <button onClick={() => onOrderChange(p.jan, p.orderQty - 1)} style={{ width: 36, height: 36, borderRadius: 18, border: "1px solid #CBD5E1", background: "#FFF", fontSize: 18, cursor: "pointer" }}>âˆ’</button>
          <input type="number" value={p.orderQty} onChange={e => onOrderChange(p.jan, parseInt(e.target.value) || 0)}
            style={{ width: 60, textAlign: "center", fontSize: 28, fontWeight: 800, border: "2px solid #0891B2", borderRadius: 8, padding: "4px 0", color: "#0891B2" }} />
          <button onClick={() => onOrderChange(p.jan, p.orderQty + 1)} style={{ width: 36, height: 36, borderRadius: 18, border: "1px solid #CBD5E1", background: "#FFF", fontSize: 18, cursor: "pointer" }}>+</button>
        </div>
        {suggested > 0 && (
          <button onClick={() => onOrderChange(p.jan, suggested)} style={{ marginTop: 8, background: "#0891B2", color: "#FFF", border: "none", borderRadius: 6, padding: "5px 16px", fontSize: 11, fontWeight: 600, cursor: "pointer" }}>
            æ¨å¥¨{suggested}ã‚’ã‚»ãƒƒãƒˆ
          </button>
        )}
      </div>

      <div style={{ display: "flex", gap: 8 }}>
        <button onClick={onPrev} style={{ flex: 1, padding: "10px 0", border: "1px solid #E2E8F0", borderRadius: 8, background: "#FFF", fontSize: 12, cursor: "pointer", fontWeight: 600 }}>â† å‰</button>
        <button onClick={onNext} style={{ flex: 1, padding: "10px 0", border: "1px solid #E2E8F0", borderRadius: 8, background: "#FFF", fontSize: 12, cursor: "pointer", fontWeight: 600 }}>æ¬¡ â†’</button>
      </div>
    </div>
  );
};

const ParamsPanel = ({ product, onParamChange, onParamChangeBatch, rowHeights }) => {
  const p = product;
  const shelfH = (rowHeights || {})[p.row] || 300;
  const avgSales = p.salesWeek ? (p.salesWeek.reduce((a, b) => a + b, 0) / 7) : 0;
  const suggestedOP = Math.ceil(avgSales * ((p.inventoryDays || 2) + (p.leadTime || 1)));

  return (
    <div>
      <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A", marginBottom: 10 }}>è‡ªå‹•è£œå……ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>

      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12, marginBottom: 10 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>åœ¨åº«ç®¡ç†</div>
        <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
          <EditableNum label="åœ¨åº«æ—¥æ•°" value={p.inventoryDays || 2} step={0.5} min={0.5} max={14} width={55} onChange={v => onParamChange(p.jan, "inventoryDays", v)} unit="æ—¥" />
          <EditableNum label="ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ " value={p.leadTime || 1} min={0} max={7} width={55} onChange={v => onParamChange(p.jan, "leadTime", v)} unit="æ—¥" />
          <EditableNum label="ç™ºæ³¨ç‚¹(OP)" value={p.orderPoint} min={0} max={999} width={55} onChange={v => onParamChange(p.jan, "orderPoint", v)} unit="å€‹" highlight={p.orderPoint !== suggestedOP} />
          <EditableNum label="åŸºæº–åœ¨åº«" value={p.baseStock} min={0} max={999} width={55} onChange={v => onParamChange(p.jan, "baseStock", v)} unit="å€‹" />
          <EditableNum label="æœ€ä½å˜ä½" value={p.minOrderUnit || 1} min={1} max={100} width={55} onChange={v => onParamChange(p.jan, "minOrderUnit", v)} unit="å€‹" />
        </div>
        {p.orderPoint !== suggestedOP && (
          <div style={{ marginTop: 8, background: "#FFFBEB", border: "1px solid #FDE68A", borderRadius: 6, padding: "6px 8px" }}>
            <div style={{ fontSize: 9, color: "#92400E" }}>æ¨å¥¨OP: {suggestedOP}ï¼ˆæ—¥è²©{avgSales.toFixed(1)}Ã—(åœ¨åº«æ—¥æ•°+LT)ï¼‰</div>
            <button onClick={() => onParamChange(p.jan, "orderPoint", suggestedOP)} style={{ marginTop: 4, background: "#F59E0B", color: "#FFF", border: "none", borderRadius: 4, padding: "3px 10px", fontSize: 10, fontWeight: 600, cursor: "pointer" }}>æ¨å¥¨å€¤é©ç”¨</button>
          </div>
        )}
      </div>

      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12, marginBottom: 10 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>æ£šå‰²ãƒ»CAPï¼ˆå¹…Ã—ç©æ®µÃ—å¥¥è¡Œï¼‰</div>
        <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
          <EditableNum label="ãƒ•ã‚§ã‚¤ã‚¹(å¹…)" value={p.face} min={1} max={6} width={55} onChange={v => { const ms = calcMaxStack(p.height_mm || 200, shelfH); onParamChangeBatch(p.jan, { face: v, cap: v * (p.depth || 3) * ms }); }} unit="åˆ—" />
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <span style={{ fontSize: 10, color: "#64748B", minWidth: 60 }}>ç©æ®µæ•°</span>
            <span style={{ fontSize: 11, fontWeight: 600, color: "#1B2A4A" }}>{calcMaxStack(p.height_mm || 200, shelfH)}æ®µ</span>
            <span style={{ fontSize: 9, color: "#94A3B8" }}>ï¼ˆH{p.height_mm||200}mm / æ£šé«˜{shelfH}mmï¼‰</span>
          </div>
          <EditableNum label="å¥¥è¡Œ" value={p.depth || 3} min={1} max={10} width={55} onChange={v => { const ms = calcMaxStack(p.height_mm || 200, shelfH); onParamChangeBatch(p.jan, { depth: v, cap: (p.face || 1) * v * ms }); }} unit="åˆ—" />
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <span style={{ fontSize: 10, color: "#64748B", minWidth: 60 }}>å•†å“å¯¸æ³•</span>
            <span style={{ fontSize: 10, color: "#94A3B8" }}>W{p.width_mm || 90} Ã— H{p.height_mm || 200} Ã— D{p.depth || 3}åˆ—</span>
          </div>
          <EditableNum label="CAP" value={p.cap} min={1} max={999} width={55} onChange={v => onParamChange(p.jan, "cap", v)} unit="å€‹" highlight={(() => { const ms = calcMaxStack(p.height_mm || 200, shelfH); return p.cap !== p.face * (p.depth || 3) * ms; })()} />
        </div>
        {(() => {
          const ms = calcMaxStack(p.height_mm || 200, shelfH);
          const calcedCap = p.face * (p.depth || 3) * ms;
          return (
            <div style={{ marginTop: 6, fontSize: 9, color: "#64748B" }}>
              è¨ˆç®—CAP = F{p.face} Ã— å¥¥è¡Œ{p.depth || 3} Ã— ç©æ®µ{ms} = <strong>{calcedCap}</strong>
              <span style={{ color: "#94A3B8" }}>ï¼ˆå•†å“H{p.height_mm||200}mm / æ£šé«˜{shelfH}mm â†’ {ms}æ®µç©ï¼‰</span>
              {p.cap !== calcedCap && <span style={{ color: "#F59E0B", fontWeight: 700 }}>ï¼ˆæ‰‹å‹•:{p.cap}ï¼‰</span>}
            </div>
          );
        })()}
      </div>

      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>åœ¨åº«ä¿®æ­£</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 8 }}>
          <div style={{ textAlign: "center" }}><div style={{ fontSize: 9, color: "#94A3B8" }}>ç†è«–åœ¨åº«</div><div style={{ fontSize: 18, fontWeight: 800 }}>{p.currentStock}</div></div>
          <div style={{ textAlign: "center" }}><div style={{ fontSize: 9, color: "#94A3B8" }}>ä¿®æ­£</div><div style={{ fontSize: 18, fontWeight: 800, color: p.stockCorrection !== 0 ? "#F59E0B" : "#94A3B8" }}>{p.stockCorrection > 0 ? "+" : ""}{p.stockCorrection}</div></div>
        </div>
        <EditableNum label="ä¿®æ­£æ•°" value={p.stockCorrection} min={-99} max={99} width={55} onChange={v => onParamChange(p.jan, "stockCorrection", v)} unit="å€‹" highlight={p.stockCorrection !== 0} />
        <div style={{ display: "flex", gap: 4, marginTop: 6 }}>
          {[-3, -1, +1, +3].map(v => (
            <button key={v} onClick={() => onParamChange(p.jan, "stockCorrection", p.stockCorrection + v)}
              style={{ flex: 1, padding: "4px 0", fontSize: 10, fontWeight: 600, border: "1px solid #CBD5E1", borderRadius: 4, cursor: "pointer", background: v > 0 ? "#ECFEFF" : "#FEF2F2", color: v > 0 ? "#0891B2" : "#EF4444" }}>{v > 0 ? "+" : ""}{v}</button>
          ))}
          <button onClick={() => onParamChange(p.jan, "stockCorrection", 0)}
            style={{ flex: 1, padding: "4px 0", fontSize: 10, fontWeight: 600, border: "1px solid #CBD5E1", borderRadius: 4, cursor: "pointer", background: "#F1F5F9", color: "#64748B" }}>0</button>
        </div>
        <div style={{ marginTop: 6, fontSize: 9, color: "#64748B" }}>å®Ÿåœ¨åº« = {p.currentStock} + ({p.stockCorrection > 0 ? "+" : ""}{p.stockCorrection}) = <strong>{p.currentStock + p.stockCorrection}</strong></div>
      </div>
    </div>
  );
};

const ChartPanel = ({ product }) => (
  <div>
    <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A", marginBottom: 8 }}>ç›´è¿‘7æ—¥é–“ è²©å£²å®Ÿç¸¾</div>
    <SalesChart data={product.salesWeek} labels={DAYS} />
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6, marginTop: 12 }}>
      {[
        { label: "æ—¥è²©å¹³å‡", value: product.salesWeek ? (product.salesWeek.reduce((a, b) => a + b, 0) / 7).toFixed(1) : "-" },
        { label: "é€±è²©åˆè¨ˆ", value: product.salesWeek ? product.salesWeek.reduce((a, b) => a + b, 0) : "-" },
        { label: "æœ€å¤§/æ—¥", value: product.salesWeek ? Math.max(...product.salesWeek) : "-" },
      ].map((s, i) => (
        <div key={i} style={{ background: "#F8FAFC", borderRadius: 8, padding: 8, textAlign: "center" }}>
          <div style={{ fontSize: 9, color: "#94A3B8" }}>{s.label}</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: "#1B2A4A" }}>{s.value}</div>
        </div>
      ))}
    </div>
  </div>
);

// ============================================================
// GONDOLA METRICS PANEL - ã‚´ãƒ³ãƒ‰ãƒ©åç›Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
// ============================================================
const GondolaMetricsPanel = ({ products, shelfWidthMm, rowCount, fixtureId, categoryName }) => {
  const tenant = useTenant();
  const tc = tenant.brand.colors;
  const [sortKey, setSortKey] = useState("weekGross");
  const m = calcGondolaMetrics(products, shelfWidthMm, rowCount);

  const revDelta = m.totalWeekRevenue - m.priorWeek.revenue;
  const revPct = m.priorWeek.revenue > 0 ? (revDelta / m.priorWeek.revenue * 100).toFixed(1) : 0;
  const profDelta = m.totalWeekProfit - m.priorWeek.profit;
  const profPct = m.priorWeek.profit > 0 ? (profDelta / m.priorWeek.profit * 100).toFixed(1) : 0;

  const sorted = [...m.skuMetrics].sort((a, b) => {
    if (sortKey === "weekRevenue") return b.weekRevenue - a.weekRevenue;
    if (sortKey === "revenuePerMm") return b.revenuePerMm - a.revenuePerMm;
    if (sortKey === "profitPerMm") return b.profitPerMm - a.profitPerMm;
    if (sortKey === "pi") return b.pi - a.pi;
    return b.weekGross - a.weekGross;
  });

  const KpiCard = ({ label, value, sub, delta, color }) => (
    <div style={{ flex: 1, background: "#FFF", border: "1px solid #E2E8F0", borderRadius: 10, padding: "12px 10px", textAlign: "center" }}>
      <div style={{ fontSize: 9, color: "#64748B", fontWeight: 600, marginBottom: 4 }}>{label}</div>
      <div style={{ fontSize: 20, fontWeight: 800, color: color || "#1E293B" }}>{value}</div>
      {sub && <div style={{ fontSize: 9, color: "#94A3B8", marginTop: 2 }}>{sub}</div>}
      {delta !== undefined && (
        <div style={{ fontSize: 10, fontWeight: 700, marginTop: 2, color: delta >= 0 ? "#10B981" : "#DC2626" }}>
          {delta >= 0 ? "+" : ""}{delta}%
        </div>
      )}
    </div>
  );

  return (
    <div style={{ padding: 16 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
        <span style={{ fontSize: 14, fontWeight: 800, color: "#1E293B" }}>ã‚´ãƒ³ãƒ‰ãƒ©åˆ†æ</span>
        <span style={{ fontSize: 11, color: "#64748B" }}>{fixtureId} | {categoryName}</span>
      </div>

      {/* KPI Cards */}
      <div style={{ display: "flex", gap: 8, marginBottom: 16 }}>
        <KpiCard label="é€±å£²ä¸Š" value={`Â¥${(m.totalWeekRevenue/1000).toFixed(1)}K`} sub={`æœˆæ¨å®š Â¥${(m.totalMonthRevenue/1000).toFixed(0)}K`} delta={parseFloat(revPct)} color={tc.primary} />
        <KpiCard label="é€±ç²—åˆ©" value={`Â¥${(m.totalWeekProfit/1000).toFixed(1)}K`} sub={`æœˆæ¨å®š Â¥${(m.totalMonthProfit/1000).toFixed(0)}K`} delta={parseFloat(profPct)} color="#10B981" />
        <KpiCard label="å……å¡«ç‡" value={`${m.fillRate}%`} sub={`${m.skuCount} SKU`} color="#6366F1" />
        <KpiCard label="PIå¹³å‡" value={m.avgPi.toFixed(1)} sub={`å£²ä¸Š/mm Â¥${m.revenuePerMm.toFixed(0)}`} color="#F59E0B" />
      </div>

      {/* å“åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ */}
      {m.outOfStockCount > 0 && (
        <div style={{ background: "#FEF2F2", border: "1px solid #FECACA", borderRadius: 8, padding: "8px 12px", marginBottom: 12, fontSize: 11 }}>
          <span style={{ fontWeight: 700, color: "#DC2626" }}>å“åˆ‡ã‚Œãƒ»åœ¨åº«ä¸è¶³: {m.outOfStockCount}å“</span>
          <span style={{ color: "#64748B", marginLeft: 8 }}>ï¼ˆå“åˆ‡ç‡ {m.outOfStockRate.toFixed(1)}%ï¼‰</span>
        </div>
      )}

      {/* SKUãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« */}
      <div style={{ fontSize: 11, color: "#64748B", fontWeight: 600, marginBottom: 6, display: "flex", alignItems: "center", gap: 8 }}>
        å•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        <select value={sortKey} onChange={e => setSortKey(e.target.value)} style={{ fontSize: 10, border: "1px solid #CBD5E1", borderRadius: 4, padding: "2px 6px" }}>
          <option value="weekGross">ç²—åˆ©é †</option>
          <option value="weekRevenue">å£²ä¸Šé †</option>
          <option value="revenuePerMm">å£²ä¸Š/mm</option>
          <option value="profitPerMm">ç²—åˆ©/mm</option>
          <option value="pi">PIå€¤</option>
        </select>
      </div>
      <div style={{ overflowX: "auto", borderRadius: 8, border: "1px solid #E2E8F0" }}>
        <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 10 }}>
          <thead>
            <tr style={{ background: "#1E293B", color: "#FFF" }}>
              <th style={{ padding: "6px 8px", textAlign: "left" }}>#</th>
              <th style={{ padding: "6px 8px", textAlign: "left", minWidth: 100 }}>å•†å“å</th>
              <th style={{ padding: "6px 8px", textAlign: "center" }}>R</th>
              <th style={{ padding: "6px 8px", textAlign: "right" }}>é€±å£²ä¸Š</th>
              <th style={{ padding: "6px 8px", textAlign: "right" }}>é€±ç²—åˆ©</th>
              <th style={{ padding: "6px 8px", textAlign: "right" }}>å£²ä¸Š/mm</th>
              <th style={{ padding: "6px 8px", textAlign: "right" }}>ç²—åˆ©/mm</th>
              <th style={{ padding: "6px 8px", textAlign: "right" }}>PIå€¤</th>
            </tr>
          </thead>
          <tbody>
            {sorted.map((s, i) => (
              <tr key={s.jan} style={{ background: i % 2 === 0 ? "#FFF" : "#F8FAFC", borderBottom: "1px solid #F1F5F9" }}>
                <td style={{ padding: "5px 8px", fontWeight: 700, color: i < 3 ? tc.primary : "#64748B" }}>{i + 1}</td>
                <td style={{ padding: "5px 8px", fontWeight: 600, color: "#1E293B" }}>{s.name.slice(0, 12)}{s.name.length > 12 ? "â€¦" : ""}</td>
                <td style={{ padding: "5px 8px", textAlign: "center" }}>
                  <span style={{ display: "inline-block", width: 18, height: 18, borderRadius: 9, background: s.rank === "A" ? "#DBEAFE" : s.rank === "B" ? "#FEF3C7" : "#F1F5F9", fontSize: 9, fontWeight: 800, lineHeight: "18px", textAlign: "center", color: s.rank === "A" ? tc.primary : s.rank === "B" ? "#D97706" : "#94A3B8" }}>{s.rank}</span>
                </td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontWeight: 600 }}>Â¥{s.weekRevenue.toLocaleString()}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontWeight: 600, color: "#10B981" }}>Â¥{s.weekGross.toLocaleString()}</td>
                <td style={{ padding: "5px 8px", textAlign: "right" }}>Â¥{s.revenuePerMm.toFixed(0)}</td>
                <td style={{ padding: "5px 8px", textAlign: "right" }}>Â¥{s.profitPerMm.toFixed(0)}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontWeight: 600, color: s.pi > 10 ? "#10B981" : s.pi > 5 ? "#F59E0B" : "#DC2626" }}>{s.pi.toFixed(1)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* æ—¥åˆ¥å£²ä¸Šãƒãƒ£ãƒ¼ãƒˆï¼ˆåˆç®—ï¼‰ */}
      <div style={{ marginTop: 16, fontSize: 11, fontWeight: 600, color: "#64748B", marginBottom: 6 }}>æ—¥åˆ¥å£²ä¸Šæ¨ç§»ï¼ˆå…¨SKUåˆç®—ï¼‰</div>
      <div style={{ display: "flex", gap: 4, alignItems: "flex-end", height: 80, background: "#F8FAFC", borderRadius: 8, padding: "8px 12px" }}>
        {["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"].map((d, di) => {
          const dayTotal = products.reduce((s, p) => s + (p.salesWeek[di] || 0) * p.price, 0);
          const maxDay = Math.max(...[0,1,2,3,4,5,6].map(i => products.reduce((s, p) => s + (p.salesWeek[i] || 0) * p.price, 0)));
          const h = maxDay > 0 ? (dayTotal / maxDay) * 60 : 0;
          return (
            <div key={d} style={{ flex: 1, textAlign: "center" }}>
              <div style={{ height: h, background: `linear-gradient(180deg, ${tc.primary}, ${tc.accent || tc.primary})`, borderRadius: "4px 4px 0 0", transition: "height 0.3s" }} />
              <div style={{ fontSize: 8, color: "#94A3B8", marginTop: 2 }}>{d}</div>
              <div style={{ fontSize: 7, color: "#64748B" }}>Â¥{(dayTotal/1000).toFixed(0)}K</div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// ============================================================
// END CAP VIEW - ã‚¨ãƒ³ãƒ‰é™³åˆ—ç®¡ç†
// ============================================================
const EndCapView = ({ endCap, editMode, onProductSelect, selected }) => {
  const tenant = useTenant();
  const tc = tenant.brand.colors;
  if (!endCap) return <div style={{ padding: 40, textAlign: "center", color: "#94A3B8" }}>ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>;

  const rows = Array.from({ length: endCap.rows }, (_, i) => i + 1);
  const totalW = endCap.widthMm || 600;
  const rh = endCap.rowHeights || {};
  const mmToPx = (mm) => Math.round((mm / 360) * 120);

  const periodStart = endCap.periodStart || "â€”";
  const periodEnd = endCap.periodEnd || "â€”";
  const today = new Date().toISOString().split("T")[0];
  const isActive = periodStart <= today && today <= periodEnd;
  const daysLeft = periodEnd ? Math.max(0, Math.ceil((new Date(periodEnd) - new Date()) / 86400000)) : "â€”";

  return (
    <div style={{ background: "#FFF", borderRadius: 12, border: "1px solid #E2E8F0", overflow: "hidden", boxShadow: "0 4px 20px rgba(0,0,0,0.08)" }}>
      {/* ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div style={{ background: `linear-gradient(135deg, ${tc.dark} 0%, ${tc.darkGrad} 100%)`, padding: "10px 16px" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <div style={{ width: 8, height: 8, borderRadius: 4, background: isActive ? "#10B981" : "#F59E0B" }} />
            <span style={{ color: "#FFF", fontSize: 12, fontWeight: 700 }}>ã‚¨ãƒ³ãƒ‰ ({endCap.side === "left" ? "å·¦" : "å³"})</span>
            <span style={{ color: "#94A3B8", fontSize: 11 }}>{totalW}mmå¹… Ã— {endCap.rows}æ®µ</span>
          </div>
          <span style={{ color: isActive ? "#10B981" : "#F59E0B", fontSize: 10, fontWeight: 700 }}>
            {isActive ? `å®Ÿæ–½ä¸­ æ®‹${daysLeft}æ—¥` : "æœŸé–“å¤–"}
          </span>
        </div>
      </div>

      {/* æœŸé–“ãƒ»ãƒ†ãƒ¼ãƒãƒãƒ¼ */}
      <div style={{ padding: "8px 16px", background: "#FFFBEB", borderBottom: "1px solid #FDE68A", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
        <div>
          <span style={{ fontSize: 12, fontWeight: 700, color: "#92400E" }}>{endCap.theme}</span>
          <span style={{ fontSize: 10, color: "#A16207", marginLeft: 8 }}>{periodStart} ï½ {periodEnd}</span>
        </div>
        <span style={{ fontSize: 10, color: "#64748B" }}>{endCap.products.length} SKU</span>
      </div>

      {/* æ£šæœ¬ä½“ */}
      <div style={{ padding: "0 2px", background: "linear-gradient(180deg, #F8FAFC 0%, #EFF3F8 100%)" }}>
        {rows.map(row => {
          const rowProducts = endCap.products.filter(p => p.row === row);
          const usedMm = rowProducts.reduce((s, p) => s + (p.width_mm || 90) * p.face, 0);
          const freeMm = totalW - usedMm;
          const rowH = rh[row] || 340;

          return (
            <div key={row}>
              <div style={{ display: "flex", alignItems: "center", padding: "4px 10px 2px", gap: 8 }}>
                <span style={{ fontSize: 11, fontWeight: 700, color: "#1E293B", minWidth: 20 }}>{row}</span>
                <div style={{ flex: 1, height: 3, background: "#E2E8F0", borderRadius: 2, overflow: "hidden" }}>
                  <div style={{ height: 3, borderRadius: 2, width: `${Math.min(100, (usedMm / totalW) * 100)}%`, background: freeMm < 30 ? "#F59E0B" : "#10B981" }} />
                </div>
                <span style={{ fontSize: 9, color: "#64748B", minWidth: 40, textAlign: "right" }}>{freeMm > 0 ? `ç©º${freeMm}mm` : "æº€"}</span>
              </div>
              <div style={{ display: "flex", padding: "0 6px", alignItems: "flex-end", gap: 2 }}>
                {rowProducts.map(p => {
                  const cellW = ((p.width_mm || 90) * p.face / totalW) * 100;
                  const cellH = mmToPx(rowH);
                  const isSelected = selected?.jan === p.jan;
                  const isLow = p.currentStock <= p.orderPoint;
                  return (
                    <div key={p.jan} onClick={() => onProductSelect && onProductSelect(p)}
                      style={{
                        width: `${cellW}%`, minWidth: 48, height: cellH, position: "relative",
                        background: isSelected ? "linear-gradient(180deg, #DBEAFE 0%, #EFF6FF 100%)" : "linear-gradient(180deg, #FFF 0%, #F8FAFC 100%)",
                        border: isSelected ? `2px solid ${tc.primary}` : isLow ? "2px solid #F87171" : "1px solid #E2E8F0",
                        borderRadius: 6, cursor: "pointer", padding: "3px 4px", overflow: "hidden",
                        boxShadow: isSelected ? `0 0 0 3px ${tc.primary}26` : "0 1px 3px rgba(0,0,0,0.06)"
                      }}>
                      <div style={{ fontSize: 9, fontWeight: 600, color: "#1E293B", overflow: "hidden", height: 22, lineHeight: "11px" }}>
                        {p.name.slice(0, 10)}{p.name.length > 10 ? "â€¦" : ""}
                      </div>
                      <div style={{ fontSize: 8, color: "#94A3B8" }}>{p.jan.slice(-4)}</div>
                      <div style={{ fontSize: 8, color: isLow ? "#DC2626" : "#64748B", marginTop: 2 }}>åœ¨åº«{p.currentStock} F:{p.face}</div>
                      {p.tag && (
                        <span style={{ position: "absolute", top: 2, right: 2, fontSize: 7, fontWeight: 700, padding: "1px 4px", borderRadius: 3, background: p.tag === "ãƒãƒ©ã‚·" ? "#DC2626" : p.tag === "è²©ä¿ƒ" ? "#F59E0B" : "#8B5CF6", color: "#FFF" }}>{p.tag}</span>
                      )}
                    </div>
                  );
                })}
                {freeMm > 20 && (
                  <div style={{ width: `${(freeMm / totalW) * 100}%`, minWidth: 24, height: mmToPx(rowH), borderRadius: 6, border: "1px dashed #D1D5DB", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 8, color: "#CBD5E1" }}>
                    {freeMm}mm
                  </div>
                )}
              </div>
              <div style={{ margin: "0 6px", height: 3, background: "linear-gradient(180deg, #94A3B8, #CBD5E1)", borderRadius: "0 0 2px 2px" }} />
            </div>
          );
        })}
      </div>
    </div>
  );
};

// ============================================================
// PROFIT PANEL - å•†å“åˆ¥ ç²—åˆ©ãƒ»å£²ä¸Šé«˜ãƒ»åç›Šåˆ†æ
// ============================================================
const ProfitPanel = ({ product, allProducts }) => {
  const p = product;
  const costRate = p.costRate || 70; // åŸä¾¡ç‡ï¼ˆ%ï¼‰
  const grossMarginRate = 100 - costRate;
  const costPrice = Math.round(p.price * costRate / 100);
  const grossProfit = p.price - costPrice; // 1å€‹ã‚ãŸã‚Šç²—åˆ©(å††)
  const weekSales = p.salesWeek ? p.salesWeek.reduce((a, b) => a + b, 0) : 0;
  const dailyAvg = weekSales / 7;
  const weekRevenue = weekSales * p.price; // é€±å£²ä¸Šé«˜
  const weekGrossProfit = weekSales * grossProfit; // é€±ç²—åˆ©é«˜
  const monthRevenue = Math.round(weekRevenue * 4.3); // æœˆæ¨å®šå£²ä¸Š
  const monthGrossProfit = Math.round(weekGrossProfit * 4.3); // æœˆæ¨å®šç²—åˆ©
  // æ£šåŠ¹ç‡ = å£²ä¸Šé«˜ / å æœ‰é¢ç©mmï¼ˆãƒ•ã‚§ãƒ¼ã‚¹å¹…ï¼‰
  const shelfWidthUsed = (p.width_mm || 90) * p.face;
  const revenuePerMm = shelfWidthUsed > 0 ? (weekRevenue / shelfWidthUsed).toFixed(1) : 0;
  const profitPerMm = shelfWidthUsed > 0 ? (weekGrossProfit / shelfWidthUsed).toFixed(1) : 0;
  // PIå€¤ = å£²ä¸Šå€‹æ•° / ãƒ¬ã‚¸é€šéå®¢æ•° Ã— 1000 ï¼ˆã“ã“ã§ã¯ç°¡æ˜“çš„ã«dailyAvgÃ—1000/500æƒ³å®šï¼‰
  const piValue = (dailyAvg * 1000 / 500).toFixed(1);

  // ã‚«ãƒ†ã‚´ãƒªå†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨
  const ranked = [...allProducts].map(pr => {
    const ws = pr.salesWeek ? pr.salesWeek.reduce((a, b) => a + b, 0) : 0;
    const gm = ws * (pr.price - Math.round(pr.price * (pr.costRate || 70) / 100));
    return { jan: pr.jan, weekGP: gm, weekRev: ws * pr.price };
  }).sort((a, b) => b.weekGP - a.weekGP);
  const gpRank = ranked.findIndex(r => r.jan === p.jan) + 1;
  const revRanked = [...ranked].sort((a, b) => b.weekRev - a.weekRev);
  const revRank = revRanked.findIndex(r => r.jan === p.jan) + 1;

  const StatBox = ({ label, value, sub, color }) => (
    <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 8, textAlign: "center" }}>
      <div style={{ fontSize: 9, color: "#94A3B8" }}>{label}</div>
      <div style={{ fontSize: 16, fontWeight: 800, color: color || "#1B2A4A" }}>{value}</div>
      {sub && <div style={{ fontSize: 9, color: "#94A3B8" }}>{sub}</div>}
    </div>
  );

  return (
    <div>
      <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A", marginBottom: 10 }}>åç›Šåˆ†æ</div>

      {/* åŸä¾¡ãƒ»ç²—åˆ© */}
      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12, marginBottom: 10 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>å˜å“åç›Š</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6 }}>
          <StatBox label="å£²ä¾¡" value={`Â¥${p.price}`} />
          <StatBox label="åŸä¾¡" value={`Â¥${costPrice}`} sub={`åŸä¾¡ç‡${costRate}%`} />
          <StatBox label="ç²—åˆ©/å€‹" value={`Â¥${grossProfit}`} sub={`ç²—åˆ©ç‡${grossMarginRate}%`} color={grossMarginRate >= 30 ? "#10B981" : "#F59E0B"} />
        </div>
      </div>

      {/* é€±æ¬¡ãƒ»æœˆæ¬¡ */}
      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12, marginBottom: 10 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>å£²ä¸Šãƒ»ç²—åˆ©é«˜</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
          <StatBox label="é€±å£²ä¸Šé«˜" value={`Â¥${weekRevenue.toLocaleString()}`} sub={`æ—¥è²©å¹³å‡ ${dailyAvg.toFixed(1)}å€‹`} />
          <StatBox label="é€±ç²—åˆ©é«˜" value={`Â¥${weekGrossProfit.toLocaleString()}`} color="#10B981" sub={`ç²—åˆ©ç‡${grossMarginRate}%`} />
          <StatBox label="æœˆæ¨å®šå£²ä¸Š" value={`Â¥${monthRevenue.toLocaleString()}`} sub="Ã—4.3é€±" />
          <StatBox label="æœˆæ¨å®šç²—åˆ©" value={`Â¥${monthGrossProfit.toLocaleString()}`} color="#10B981" sub="Ã—4.3é€±" />
        </div>
      </div>

      {/* æ£šåŠ¹ç‡ */}
      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12, marginBottom: 10 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>æ£šåŠ¹ç‡</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6 }}>
          <StatBox label="å æœ‰å¹…" value={`${shelfWidthUsed}mm`} sub={`${p.width_mm||90}mmÃ—F${p.face}`} />
          <StatBox label="é€±å£²ä¸Š/mm" value={`Â¥${revenuePerMm}`} />
          <StatBox label="é€±ç²—åˆ©/mm" value={`Â¥${profitPerMm}`} color="#10B981" />
        </div>
        <div style={{ marginTop: 6, fontSize: 9, color: "#64748B" }}>
          PIå€¤: {piValue} | ã‚«ãƒ†ã‚´ãƒªå†… å£²ä¸Š{revRank}ä½ / ç²—åˆ©{gpRank}ä½ï¼ˆå…¨{allProducts.length}SKUï¼‰
        </div>
      </div>

      {/* æ—¥åˆ¥ç²—åˆ©ãƒãƒ£ãƒ¼ãƒˆ */}
      <div style={{ background: "#F8FAFC", borderRadius: 8, padding: 12 }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#0891B2", marginBottom: 8 }}>æ—¥åˆ¥ç²—åˆ©ï¼ˆç›´è¿‘7æ—¥ï¼‰</div>
        <div style={{ display: "flex", alignItems: "flex-end", gap: 4 }}>
          {(p.salesWeek || [0,0,0,0,0,0,0]).map((v, i) => {
            const dayGP = v * grossProfit;
            const maxGP = Math.max(...(p.salesWeek || [1]).map(s => s * grossProfit)) * 1.2;
            return (
              <div key={i} style={{ textAlign: "center", flex: 1 }}>
                <div style={{ fontSize: 8, color: "#64748B", marginBottom: 1 }}>Â¥{dayGP}</div>
                <div style={{ height: Math.max(4, (dayGP / maxGP) * 80), background: "#10B981", borderRadius: "3px 3px 0 0", transition: "height 0.3s" }} />
                <div style={{ fontSize: 9, color: "#94A3B8", marginTop: 2 }}>{DAYS[i]}</div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

const InfoPanel = ({ product }) => (
  <div>
    <div style={{ fontSize: 12, fontWeight: 700, color: "#1B2A4A", marginBottom: 8 }}>å•†å“æƒ…å ±</div>
    {[
      { label: "å•†å“å", value: product.name },
      { label: "JAN", value: product.jan },
      { label: "ãƒ¡ãƒ¼ã‚«ãƒ¼", value: product.maker },
      { label: "å£²ä¾¡", value: `Â¥${product.price}` },
      { label: "ãƒ©ãƒ³ã‚¯", value: product.rank },
      { label: "æ£šä½ç½®", value: `${product.row}æ®µ` },
      { label: "å•†å“å¹…", value: `${product.width_mm || 90}mm Ã— F${product.face} = ${(product.width_mm || 90) * product.face}mm` },
      { label: "ãƒ•ã‚§ã‚¤ã‚¹", value: product.face },
      { label: "å¥¥è¡Œ", value: product.depth || "-" },
      { label: "CAP", value: product.cap || "-" },
      { label: "åœ¨åº«æ—¥æ•°", value: product.inventoryDays ? `${product.inventoryDays}æ—¥` : "-" },
      { label: "LT", value: product.leadTime ? `${product.leadTime}æ—¥` : "-" },
      { label: "ç¾åœ¨åº«", value: product.currentStock },
    ].map((item, i) => (
      <div key={i} style={{ display: "flex", borderBottom: "1px solid #F1F5F9", padding: "6px 0" }}>
        <div style={{ width: 80, fontSize: 11, color: "#94A3B8" }}>{item.label}</div>
        <div style={{ flex: 1, fontSize: 11, color: "#1B2A4A", fontWeight: 600 }}>{item.value}</div>
      </div>
    ))}
  </div>
);

// ============================================================
// STYLES
// ============================================================
const backBtnStyle = { background: "none", border: "1px solid #64748B", color: "#CBD5E1", borderRadius: 6, padding: "4px 10px", fontSize: 11, cursor: "pointer" };
const pillBtnStyle = { border: "none", color: "#CBD5E1", borderRadius: 6, padding: "5px 10px", fontSize: 11, cursor: "pointer" };
const thStyle = { padding: "6px 4px", fontSize: 10, fontWeight: 600, textAlign: "center", whiteSpace: "nowrap" };
const tdStyle = { padding: "6px 4px", fontSize: 11, whiteSpace: "nowrap" };

// ============================================================
// MAIN APP
// ============================================================
export default function App() {
  const [screen, setScreen] = useState("portal");
  const [showDcs, setShowDcs] = useState(false);
  const [dcsProcessed, setDcsProcessed] = useState({ cut: 0, face: 0, total: 0 });
  const [dcsTaskDone, setDcsTaskDone] = useState({});
  const [selectedDepartment, setSelectedDepartment] = useState(null);
  const [loading, setLoading] = useState(true);
  const [dataLoaded, setDataLoaded] = useState(false);
  const [loadError, setLoadError] = useState(null);

  // Load data directly from bundled JSON (no server required)
  useEffect(() => {
    try {
      // Try localStorage first (for imported data), fall back to bundled default
      let storeData;
      try {
        const saved = localStorage.getItem('james-store-data');
        if (saved) {
          storeData = JSON.parse(saved);
          console.log('Restored data from localStorage');
        } else {
          storeData = storeDataDefault;
        }
      } catch (e) {
        storeData = storeDataDefault;
      }

      // Store info for display
      STORE_INFO = {
        company: storeData.company || '',
        storeName: storeData.storeName || '',
        periodFrom: storeData.periodFrom || '20260101',
        periodTo: storeData.periodTo || '20260101',
        periodDays: storeData.periodDays || 0
      };

      // Build departments object
      DEPARTMENTS = storeData.departments || {};

      // Load fixtures directly from JSON
      FIXTURES = {};
      Object.entries(storeData.fixtures || {}).forEach(([id, f]) => {
        FIXTURES[id] = {
          ...f,
          fixtureId: id,
          fixtureType: f.fixtureType || 'gondola',
        };
      });

      // Run DCS engine after fixtures are loaded
      runDcsEngine(FIXTURES, parseInt(STORE_INFO.periodDays) || 49);

      // Build CATEGORIES from departments - only show main departments with 3+ gondolas
      CATEGORIES.length = 0;
      Object.entries(DEPARTMENTS).forEach(([dept, gondolaCodes]) => {
        if (gondolaCodes.length >= 3) {
          CATEGORIES.push({
            id: dept,
            name: dept,
            group: dept,
            gondolaCodes
          });
        }
      });

      setDataLoaded(true);

      // DCSææ¡ˆã‚’APIã‹ã‚‰éåŒæœŸãƒ­ãƒ¼ãƒ‰
      loadDcsProposals().then(proposals => {
        if (proposals.length > 0) {
          console.log(`[DCS] ${proposals.length}ä»¶ã®ææ¡ˆã‚’ãƒ­ãƒ¼ãƒ‰å®Œäº†`);
        }
      }).catch(e => console.warn('[DCS] proposals load failed:', e.message));

    } catch (error) {
      console.error('Failed to load data:', error);
      setLoadError(error.message);
    } finally {
      setLoading(false);
    }
  }, []);

  // ãƒ†ãƒŠãƒ³ãƒˆè¨­å®šã«å¿œã˜ã¦ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‹•çš„è¨­å®š
  useEffect(() => {
    document.title = `${tenantConfig.brand.name} - ${tenantConfig.brand.subtitle}`;
  }, []);

  const handleDataImport = useCallback((storeData) => {
    // Update module-level data
    STORE_INFO = {
      company: storeData.company || '',
      storeName: storeData.storeName || '',
      periodFrom: storeData.periodFrom || '20260101',
      periodTo: storeData.periodTo || '20260101',
      periodDays: storeData.periodDays || 0
    };
    DEPARTMENTS = storeData.departments || {};
    FIXTURES = {};
    Object.entries(storeData.fixtures || {}).forEach(([id, f]) => {
      FIXTURES[id] = { ...f, fixtureId: id, fixtureType: f.fixtureType || 'gondola' };
    });
    // Run DCS engine after fixtures are loaded
    runDcsEngine(FIXTURES, parseInt(STORE_INFO.periodDays) || 49);
    CATEGORIES.length = 0;
    Object.entries(DEPARTMENTS).forEach(([dept, gondolaCodes]) => {
      if (gondolaCodes.length >= 3) {
        CATEGORIES.push({ id: dept, name: dept, group: dept, gondolaCodes });
      }
    });
    // Save to localStorage for persistence
    try {
      localStorage.setItem('james-store-data', JSON.stringify(storeData));
    } catch (e) { console.warn('Failed to save to localStorage:', e); }
    setDataLoaded(true);
    setScreen("portal");
  }, []);

  // Show loading screen while data is loading
  if (loading) {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100vh',
        backgroundColor: '#F8FAFC',
        fontSize: 16,
        color: '#64748B'
      }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: 18, fontWeight: 700, color: '#1B2A4A', marginBottom: 16 }}>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          <div style={{ width: 40, height: 40, border: '4px solid #E2E8F0', borderTop: '4px solid #0891B2', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto' }} />
        </div>
        <style>{`
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `}</style>
      </div>
    );
  }

  if (!dataLoaded) {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100vh',
        backgroundColor: '#F8FAFC',
        fontSize: 16,
        color: '#DC2626'
      }}>
        <div style={{ textAlign: 'center', maxWidth: 480, padding: 24 }}>
          <div style={{ fontSize: 24, marginBottom: 12 }}>âš ï¸</div>
          <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 12 }}>ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼</div>
          {loadError && (
            <div style={{ fontSize: 13, color: '#64748B', marginBottom: 16, padding: 12, background: '#FEF2F2', borderRadius: 8, border: '1px solid #FECACA', wordBreak: 'break-all' }}>
              {loadError}
            </div>
          )}
          <div style={{ fontSize: 13, color: '#64748B', marginBottom: 20 }}>
            ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          </div>
          <button onClick={() => window.location.reload()} style={{
            background: '#0891B2', color: '#FFF', border: 'none', borderRadius: 8,
            padding: '10px 24px', fontSize: 14, fontWeight: 700, cursor: 'pointer'
          }}>å†èª­è¾¼</button>
        </div>
      </div>
    );
  }

  const content = (() => {
    if (screen === "portal") {
      return <PortalScreen userName="åº—é•· ä½ã€…æœ¨" dcsProcessed={dcsProcessed} dcsTaskDone={dcsTaskDone} onDataImport={handleDataImport} onNavigate={(s) => {
        if (s === "category-select-dcs") { setShowDcs(true); setScreen("category-select"); }
        else { setShowDcs(false); setScreen(s); }
      }} />;
    }
    if (screen === "category-select") {
      return <CategorySelectScreen onBack={() => setScreen("portal")} onSelect={(dept) => {
        setSelectedDepartment(dept);
        setScreen("shelf-view");
      }} showDcs={showDcs} />;
    }
    if (screen === "shelf-view") {
      return <ShelfViewScreen data={{ departmentKey: selectedDepartment }} onBack={() => setScreen("category-select")} onHome={() => setScreen("portal")} showDcs={showDcs}
        onDcsProcessedChange={setDcsProcessed} onDcsTaskDoneChange={setDcsTaskDone} dcsTaskDone={dcsTaskDone} />;
    }
    return <PortalScreen userName="åº—é•· ä½ã€…æœ¨" dcsProcessed={dcsProcessed} dcsTaskDone={dcsTaskDone} onDataImport={handleDataImport} onNavigate={() => {}} />;
  })();

  return (
    <TenantContext.Provider value={tenantConfig}>
      {content}
    </TenantContext.Provider>
  );
}
